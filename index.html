<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/Easygo-Address/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <title>Easy Go | Secure Payment</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased bg-gray-50 min-h-screen">

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 text-center">
            <div class="loader mx-auto mb-6"></div>
            <h3 class="text-2xl font-bold mb-4">Processing Payment</h3>
            <p class="text-gray-600 mb-6">Please wait...</p>
            <p class="text-sm text-gray-500">Do not close or minimize the app</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 text-center">
            <div class="text-6xl mb-6">üéâ</div>
            <h3 class="text-2xl font-bold mb-4">Payment Successful!</h3>
            <p class="text-gray-600 mb-6">Your order has been confirmed.</p>
            
            <div class="text-4xl font-bold text-green-600 mb-6 bg-gray-100 p-4 rounded-2xl" id="generated-otp">
                Loading...
            </div>
            
            <div class="bg-green-50 border border-green-200 rounded-2xl p-4 mb-6">
                <p class="text-sm text-green-800">
                    <strong>Next steps:</strong> Share this OTP at pickup/delivery.
                </p>
            </div>
            
            <button id="go-to-tracking" 
                    class="w-full py-4 bg-blue-500 text-white font-bold rounded-2xl hover:bg-blue-600 transition-colors">
                Track Your Order ‚Üí
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 pt-6 pb-20">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Order Summary -->
            <div class="space-y-8">
                <div class="bg-white rounded-3xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6">Order Summary</h2>
                    <div id="order-items" class="space-y-4 mb-6 max-h-80 overflow-y-auto"></div>
                    <div class="border-t pt-6">
                        <h3 class="font-bold mb-4">Customer Details</h3>
                        <div id="customer-details"></div>
                    </div>
                </div>
                
                <div class="bg-white rounded-3xl shadow-lg p-6">
                    <h3 class="font-bold mb-4">Order Details</h3>
                    <div id="delivery-address"></div>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div class="space-y-8">
                <div class="bg-white rounded-3xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6">Payment Summary</h2>
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between py-2">
                            <span class="text-gray-700">Food Items Total</span>
                            <span id="food-total" class="font-semibold">‚Çπ0</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-700">GST on Food (5%)</span>
                            <span id="gst-food" class="font-semibold">‚Çπ0</span>
                        </div>
                        <div id="delivery-row" class="border-t pt-4 mt-2 hidden">
                            <div class="flex justify-between py-2">
                                <span class="text-gray-700">Delivery Charge</span>
                                <span id="delivery-charge" class="font-semibold">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-700">GST on Delivery</span>
                                <span id="gst-delivery" class="font-semibold">‚Çπ0</span>
                            </div>
                        </div>
                        <div class="border-t-2 border-gray-300 pt-4 mt-2">
                            <div class="flex justify-between text-xl font-bold py-2">
                                <span class="text-gray-800">Total Amount</span>
                                <span id="final-total" class="text-green-600">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-3xl shadow-lg p-6">
                    <div class="text-center mb-8">
                        <div class="inline-block bg-green-50 border border-green-200 text-green-800 px-8 py-4 rounded-2xl mb-4">
                            <div class="text-sm font-medium mb-1">Total to pay</div>
                            <span class="font-bold text-3xl" id="payment-amount">‚Çπ0</span>
                        </div>
                        <p class="text-gray-600 mb-2">100% Secure Payment via Razorpay</p>
                        <p class="text-xs text-gray-500">Cards ‚Ä¢ UPI ‚Ä¢ NetBanking ‚Ä¢ Wallet</p>
                    </div>
                    
                    <button id="razorpay-pay-btn" 
                            class="w-full py-4 bg-blue-600 text-white text-xl font-bold rounded-2xl hover:bg-blue-700 transition-colors mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
                        Pay Now - ‚Çπ<span id="pay-amount">0</span>
                    </button>
                    
                    <div class="text-center pt-4">
                        <p class="text-xs text-gray-500 mb-4">Powered by Razorpay | PCI DSS Certified</p>
                        <a href="https://clean-scripts.github.io/Easygo-Address/" 
                           class="text-gray-600 hover:text-gray-900 flex items-center justify-center">
                            <span class="text-xl mr-2">‚Üê</span>
                            <span>Back to Address</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // CONFIGURATION
    const RAZORPAY_KEY_ID = "rzp_live_RySoaT17nxFQSV";
    const RESTAURANT_PHONE = "917651837322";
    
    // GLOBAL STATE
    let orderData = {};
    let finalAmount = 0;
    let paymentProcessing = false;
    let currentRazorpayInstance = null;
    
    // LOAD ORDER DATA
    function loadOrderData() {
        try {
            const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
            const address = JSON.parse(localStorage.getItem('easygo-address') || '{}');
            const delivery = JSON.parse(localStorage.getItem('easygo-delivery') || '{}');
            
            if (cart.length === 0) {
                alert("Your cart is empty. Redirecting to menu...");
                setTimeout(() => window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/', 2000);
                return false;
            }
            
            const deliveryMode = address.deliveryMode || delivery.mode || 'takeaway';
            
            let foodTotal = 0;
            cart.forEach(item => {
                const unitPrice = parseFloat(item.unitPrice) || 0;
                const quantity = parseInt(item.quantity) || 1;
                foodTotal += unitPrice * quantity;
            });
            
            if (foodTotal <= 0) {
                foodTotal = parseFloat(localStorage.getItem('easygo-cart-items-total')) || 0;
            }
            
            if (foodTotal <= 0) {
                alert("Invalid order amount. Please refresh page.");
                return false;
            }
            
            const gstFood = Math.round((foodTotal * 0.05) * 100) / 100;
            let deliveryCharge = 0;
            let gstDelivery = 0;
            
            if (deliveryMode === 'delivery') {
                deliveryCharge = parseFloat(delivery.charge) || 49;
                if (deliveryCharge !== 9) {
                    gstDelivery = Math.round((deliveryCharge * 0.18) * 100) / 100;
                }
            }
            
            finalAmount = parseFloat((foodTotal + gstFood + deliveryCharge + gstDelivery).toFixed(2));
            
            if (finalAmount < 1) {
                alert("Invalid total amount. Please contact support.");
                return false;
            }
            
            displayCartItems(cart);
            displayCustomerDetails(address);
            displayDeliveryAddress(address, delivery);
            updatePaymentUI(foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode);
            
            orderData = { 
                cart, 
                address, 
                delivery, 
                amount: finalAmount,
                totals: { foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode }
            };
            
            return true;
            
        } catch (error) {
            console.error("Error loading order data:", error);
            alert("Failed to load order. Please refresh the page.");
            return false;
        }
    }
    
    function updatePaymentUI(foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode) {
        document.getElementById('food-total').textContent = `‚Çπ${foodTotal.toFixed(2)}`;
        document.getElementById('gst-food').textContent = `‚Çπ${gstFood.toFixed(2)}`;
        
        if (deliveryMode === 'delivery') {
            document.getElementById('delivery-row').classList.remove('hidden');
            document.getElementById('delivery-charge').textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
            document.getElementById('gst-delivery').textContent = deliveryCharge === 9 ? '‚Çπ0.00 (Included)' : `‚Çπ${gstDelivery.toFixed(2)}`;
        }
        
        const totalDisplay = `‚Çπ${finalAmount.toFixed(2)}`;
        document.getElementById('final-total').textContent = totalDisplay;
        document.getElementById('payment-amount').textContent = totalDisplay;
        document.getElementById('pay-amount').textContent = finalAmount.toFixed(2);
    }
    
    // DISPLAY FUNCTIONS
    function displayCartItems(cart) {
        const orderItems = document.getElementById('order-items');
        if (!orderItems) return;
        
        orderItems.innerHTML = '';
        cart.forEach(item => {
            const quantity = parseInt(item.quantity) || 1;
            const unitPrice = parseFloat(item.unitPrice) || 0;
            const totalPrice = unitPrice * quantity;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-xl';
            itemDiv.innerHTML = `
                <div class="flex-1">
                    <p class="font-semibold text-gray-800">${item.name || 'Food Item'}</p>
                    <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                        <span>Qty: ${quantity}</span>
                        <span>Pack: ${item.pack || 'Family'}</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold text-gray-800">‚Çπ${totalPrice.toFixed(2)}</div>
                </div>
            `;
            orderItems.appendChild(itemDiv);
        });
    }
    
    function displayCustomerDetails(address) {
        const customerDetails = document.getElementById('customer-details');
        if (!customerDetails) return;
        
        if (!address || !address.name) {
            customerDetails.innerHTML = `<p class="text-red-600">Customer details not found</p>`;
            return;
        }
        
        customerDetails.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <p class="font-semibold">${address.name}</p>
                <p class="text-sm text-gray-600 mt-1">${address.phone || 'Phone not provided'}</p>
            </div>
        `;
    }
    
    function displayDeliveryAddress(address, delivery) {
        const deliveryAddress = document.getElementById('delivery-address');
        if (!deliveryAddress) return;
        
        const deliveryMode = address.deliveryMode || delivery.mode || 'takeaway';
        
        if (deliveryMode === 'delivery') {
            if (address.houseNumber || address.locality) {
                const addressLine1 = `${address.houseNumber || ''}${address.houseNumber && address.locality ? ', ' : ''}${address.locality || ''}`;
                const cityLine = `${address.city || 'Indore'}, ${address.state || 'MP'} - ${address.pincode || ''}`;
                
                deliveryAddress.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                        <p class="font-semibold mb-2">Delivery Address</p>
                        <p class="text-gray-700">${addressLine1}</p>
                        <p class="text-gray-700">${address.street || ''}</p>
                        <p class="text-gray-700">${cityLine}</p>
                    </div>
                `;
            } else {
                deliveryAddress.innerHTML = `<p class="text-red-600">Address details incomplete</p>`;
            }
        } else {
            deliveryAddress.innerHTML = `
                <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
                    <p class="font-semibold mb-2">Pickup Details</p>
                    <p class="text-gray-700">Prime Square, Omaxe City 1, Indore</p>
                    <p class="text-sm text-gray-600 mt-2">Timings: 6:00 PM - 10:00 PM</p>
                </div>
            `;
        }
    }
    
    // RAZORPAY PAYMENT WITH UPI FIX
    function initiateRazorpayPayment() {
        if (paymentProcessing) {
            alert("A payment is already in progress. Please wait.");
            return;
        }
        
        if (!orderData.address?.phone) {
            alert("Please add your phone number for payment verification");
            return;
        }
        
        if (finalAmount < 1) {
            alert("Invalid payment amount. Please refresh page.");
            return;
        }
        
        paymentProcessing = true;
        showLoading("Opening payment gateway...");
        
        // Force payment in browser context (not in-app browser)
        if (window.inAppBrowserDetected) {
            alert("For best payment experience, please open in Chrome/Safari browser instead of Instagram/Facebook app.");
        }
        
        const options = {
            key: RAZORPAY_KEY_ID,
            amount: Math.round(finalAmount * 100),
            currency: "INR",
            name: "Easy Go",
            description: "Order Payment",
            prefill: {
                name: orderData.address.name || "Customer",
                contact: orderData.address.phone || "",
                email: "customer@easygo.com"
            },
            handler: function(response) {
                handlePaymentSuccess(response);
            },
            theme: { 
                color: "#10B981"
            },
            modal: {
                ondismiss: function() {
                    handlePaymentDismiss();
                },
                // Allow backdrop close to prevent trapping users
                backdropclose: true
            },
            // Add timeout to prevent hanging
            timeout: 300,
            // Enable retry for failed payments
            retry: {
                enabled: true,
                max_count: 2
            },
            // Important for UPI: Use external browser intent
            external: {
                wallets: ['paytm', 'phonepe', 'gpay', 'bhim'],
                UPI: true
            }
        };
        
        try {
            const rzp = new Razorpay(options);
            currentRazorpayInstance = rzp;
            
            rzp.on('payment.failed', function(response) {
                handlePaymentFailure(response);
            });
            
            rzp.on('payment.error', function(response) {
                handlePaymentError(response);
            });
            
            rzp.open();
            
        } catch (error) {
            console.error("Payment initialization error:", error);
            hideLoading();
            paymentProcessing = false;
            alert("Unable to initialize payment. Please check your internet connection and try again.");
        }
    }
    
    function handlePaymentSuccess(response) {
        hideLoading();
        paymentProcessing = false;
        
        if (!response.razorpay_payment_id) {
            alert("Payment completed but verification failed. Please contact support with your transaction ID.");
            return;
        }
        
        const otp = Math.floor(100000 + Math.random() * 900000).toString();
        const orderId = "EG" + Date.now().toString().slice(-8);
        
        const order = {
            id: orderId,
            paymentId: response.razorpay_payment_id,
            otp: otp,
            amount: finalAmount,
            customer: orderData.address.name || 'Customer',
            phone: orderData.address.phone || '',
            items: orderData.cart,
            deliveryMode: orderData.totals.deliveryMode,
            timestamp: new Date().toISOString()
        };
        
        saveOrder(order);
        sendWhatsAppNotification(order);
        
        document.getElementById('generated-otp').textContent = otp;
        document.getElementById('success-modal').classList.remove('hidden');
    }
    
    function handlePaymentFailure(response) {
        hideLoading();
        paymentProcessing = false;
        
        let errorMsg = "Payment failed. Please try again.";
        if (response.error && response.error.description) {
            errorMsg = response.error.description;
        }
        
        alert(errorMsg);
        
        // Store payment failure for analytics
        try {
            const failures = JSON.parse(localStorage.getItem('easygo-payment-failures') || '[]');
            failures.push({
                timestamp: new Date().toISOString(),
                error: response.error,
                amount: finalAmount
            });
            localStorage.setItem('easygo-payment-failures', JSON.stringify(failures));
        } catch (e) {
            console.error("Failed to save payment failure:", e);
        }
    }
    
    function handlePaymentError(response) {
        hideLoading();
        paymentProcessing = false;
        
        console.error("Payment error:", response);
        alert("A payment error occurred. Please try again or use a different payment method.");
    }
    
    function handlePaymentDismiss() {
        hideLoading();
        paymentProcessing = false;
        
        // Check if payment might have been successful despite dismissal
        checkForPendingPayment();
    }
    
    function checkForPendingPayment() {
        // Sometimes UPI payments succeed but callback fails
        setTimeout(() => {
            alert("If payment was deducted but order not confirmed, please contact us at +91 76518 37322 with your transaction ID for manual verification.");
        }, 2000);
    }
    
    function showLoading(message) {
        document.getElementById('loading-message').textContent = message;
        document.getElementById('loading-modal').classList.remove('hidden');
        document.getElementById('razorpay-pay-btn').disabled = true;
    }
    
    function hideLoading() {
        document.getElementById('loading-modal').classList.add('hidden');
        document.getElementById('razorpay-pay-btn').disabled = false;
    }
    
    // ADDRESS EXTRACTION AND WHATSAPP NOTIFICATION
    function extractUserAddress() {
        try {
            const addressData = JSON.parse(localStorage.getItem('easygo-address') || '{}');
            const deliveryData = JSON.parse(localStorage.getItem('easygo-delivery') || '{}');
            
            if (!addressData.name) return "No address data";
            
            let addressText = "";
            addressText += `Name: ${addressData.name}\n`;
            addressText += `Phone: ${addressData.phone || 'Not provided'}\n`;
            
            const deliveryMode = addressData.deliveryMode || deliveryData.mode || 'takeaway';
            addressText += `Type: ${deliveryMode === 'delivery' ? 'Home Delivery' : 'Takeaway'}\n`;
            
            if (deliveryMode === 'delivery') {
                if (addressData.houseNumber || addressData.locality) {
                    addressText += `Address: ${addressData.houseNumber || ''}${addressData.houseNumber && addressData.locality ? ', ' : ''}${addressData.locality || ''}\n`;
                    if (addressData.street) addressText += `Street: ${addressData.street}\n`;
                    addressText += `City: ${addressData.city || 'Indore'}\n`;
                    addressText += `Pincode: ${addressData.pincode || ''}\n`;
                }
                
                if (deliveryData.distance) {
                    addressText += `Distance: ${deliveryData.distance} km\n`;
                }
            } else {
                addressText += `Pickup: Prime Square, Omaxe City 1, Indore\n`;
            }
            
            return addressText;
        } catch (error) {
            console.error("Error extracting address:", error);
            return "Address extraction failed";
        }
    }
    
    function sendWhatsAppNotification(order) {
        let message = `üì¶ *NEW ORDER - ${order.id}* üì¶\n\n`;
        
        message += `*Customer:* ${order.customer}\n`;
        message += `*Phone:* ${order.phone}\n`;
        message += `*OTP:* ${order.otp}\n`;
        message += `*Amount:* ‚Çπ${order.amount.toFixed(2)}\n`;
        message += `*Payment ID:* ${order.paymentId}\n`;
        message += `*Type:* ${order.deliveryMode === 'delivery' ? 'Home Delivery' : 'Takeaway'}\n\n`;
        
        message += `*Items:*\n`;
        order.items.forEach(item => {
            const qty = parseInt(item.quantity) || 1;
            const price = parseFloat(item.unitPrice) || 0;
            message += `‚Ä¢ ${item.name} √ó ${qty} - ‚Çπ${(price * qty).toFixed(2)}\n`;
        });
        
        message += `\n`;
        message += extractUserAddress();
        message += `\n\n*Order Time:* ${new Date().toLocaleTimeString()}, ${new Date().toLocaleDateString()}`;
        
        const encodedMessage = encodeURIComponent(message);
        const whatsappURL = `https://wa.me/${RESTAURANT_PHONE}?text=${encodedMessage}`;
        
        // Open WhatsApp after a short delay
        setTimeout(() => {
            window.open(whatsappURL, '_blank');
        }, 1500);
    }
    
    function saveOrder(order) {
        try {
            const orderRecord = {
                ...order,
                address: orderData.address,
                delivery: orderData.delivery
            };
            
            localStorage.setItem('easygo-orders', JSON.stringify([orderRecord]));
            localStorage.setItem('easygo-otp', order.otp);
            localStorage.setItem('easygo-order-id', order.id);
            localStorage.setItem('easygo-last-order', JSON.stringify(orderRecord));
            
            localStorage.removeItem('easygo-cart');
            localStorage.removeItem('easygo-cart-items-total');
            
        } catch (error) {
            console.error("Error saving order:", error);
        }
    }
    
    // DETECT IN-APP BROWSER
    function detectInAppBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        const isInstagram = userAgent.includes('instagram');
        const isFacebook = userAgent.includes('fban') || userAgent.includes('fbav');
        const isTwitter = userAgent.includes('twitter');
        
        if (isInstagram || isFacebook || isTwitter) {
            window.inAppBrowserDetected = true;
            return true;
        }
        return false;
    }
    
    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', function() {
        // Detect in-app browser first
        if (detectInAppBrowser()) {
            alert("‚ö†Ô∏è For best payment experience, please open this page in Chrome/Safari browser instead of social media app.");
        }
        
        if (!loadOrderData()) {
            return;
        }
        
        document.getElementById('razorpay-pay-btn').addEventListener('click', initiateRazorpayPayment);
        document.getElementById('go-to-tracking').addEventListener('click', function() {
            window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
        });
        
        // Add browser compatibility warning
        if (!window.inAppBrowserDetected && /android|iphone|ipad|ipod/i.test(navigator.userAgent)) {
            console.log("Mobile browser detected - payment should work properly");
        }
    });
</script>
    
</body>
</html>
