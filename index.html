<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <title>Easy Go | Payment</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .payment-step { transition: all 0.3s; }
        .payment-step.active { border-color: #10b981; background-color: #f0fdf4; }
        .razorpay-payment-button { display: none !important; }
        .error-message { 
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased bg-gray-50">

    <header class="relative mb-8">
        <div class="h-40 overflow-hidden">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                 class="w-full h-full object-cover" alt="Easy Go Banner">
        </div>
        <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                 class="h-20 w-20 rounded-full border-4 border-white shadow-xl bg-white p-1">
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 pt-10 pb-20">
        <!-- Error Message -->
        <div id="error-message" class="error-message fixed top-4 right-4 bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-2xl shadow-lg z-50 max-w-md">
            <div class="flex items-center">
                <div class="text-2xl mr-3">‚ö†Ô∏è</div>
                <div>
                    <h4 class="font-bold">Payment Error</h4>
                    <p id="error-text" class="text-sm mt-1"></p>
                </div>
                <button onclick="hideError()" class="ml-6 text-red-500 hover:text-red-700">‚úï</button>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="flex justify-center mb-12">
            <div class="flex items-center">
                <div class="payment-step w-12 h-12 rounded-full border-4 border-gray-300 flex items-center justify-center font-bold text-gray-500">
                    1
                </div>
                <div class="w-24 h-1 bg-gray-300"></div>
                <div class="payment-step w-12 h-12 rounded-full border-4 border-gray-300 flex items-center justify-center font-bold text-gray-500">
                    2
                </div>
                <div class="w-24 h-1 bg-gray-300"></div>
                <div class="payment-step w-12 h-12 rounded-full border-4 border-green-500 bg-green-500 text-white flex items-center justify-center font-bold">
                    3
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Order Summary -->
            <div>
                <div class="bg-white rounded-3xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold mb-6">üì¶ Order Summary</h2>
                    
                    <div id="order-items" class="space-y-4 mb-6">
                        <!-- Items loaded from localStorage -->
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="font-bold mb-4">üìù Customer Details</h3>
                        <div id="customer-details" class="space-y-2">
                            <!-- Details loaded from localStorage -->
                        </div>
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="font-bold mb-4">üìç Delivery Address</h3>
                        <div id="delivery-address" class="space-y-2">
                            <!-- Address loaded from localStorage -->
                        </div>
                    </div>
                </div>
                
                <!-- Payment Instructions -->
                <div class="bg-blue-50 border border-blue-200 rounded-3xl p-8">
                    <h3 class="font-bold text-blue-800 mb-4">üí≥ Payment Instructions</h3>
                    <ul class="space-y-2 text-blue-700">
                        <li>‚úÖ Amount is auto-calculated from your cart</li>
                        <li>‚úÖ Multiple payment options available via Razorpay</li>
                        <li>‚úÖ Instant payment confirmation</li>
                        <li>‚úÖ OTP will be generated after payment</li>
                    </ul>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div>
                <div class="bg-white rounded-3xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold mb-6">üí∞ Payment Breakdown</h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between">
                            <span>Food Items Total</span>
                            <span id="food-total">‚Çπ0</span>
                        </div>
                        
                        <div id="coupon-row" class="flex justify-between text-green-600 hidden">
                            <span>Coupon Discount</span>
                            <span id="coupon-discount">-‚Çπ0</span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span>GST on Food (5%)</span>
                            <span id="gst-food">‚Çπ0</span>
                        </div>
                        
                        <div id="delivery-row" class="hidden">
                            <div class="flex justify-between">
                                <span>Delivery Charge</span>
                                <span id="delivery-charge">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>GST on Delivery (18%)</span>
                                <span id="gst-delivery">‚Çπ0</span>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <div class="flex justify-between text-xl font-bold">
                                <span>Total Amount</span>
                                <span id="final-total">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Options -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üí≥ Secure Payment</h2>
                    
                    <div class="space-y-4 mb-6">
                        <button id="razorpay-pay-btn" 
                                class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-xl font-bold rounded-2xl hover:opacity-90 transition-opacity flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.436 7.406H1.564a1.25 1.25 0 0 0-1.108 1.831l1.414 2.823a1.25 1.25 0 0 0 1.108.669h19.242a1.25 1.25 0 0 0 1.108-.669l1.414-2.823a1.25 1.25 0 0 0-1.108-1.831z"/>
                                <path d="M2.5 12.406h19v9h-19z"/>
                            </svg>
                            Pay with Razorpay - ‚Çπ<span id="pay-amount">0</span>
                        </button>
                        
                        <div class="text-center text-sm text-gray-500 mb-4">
                            Powered by Razorpay - Accepts Cards, UPI, NetBanking & Wallets
                        </div>
                    </div>
                    
                    <div class="text-center mb-6">
                        <p class="text-3xl font-bold text-blue-600 mb-2" id="payment-amount">‚Çπ0</p>
                        <p class="text-gray-600 text-sm">Final amount payable</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <a href="https://clean-scripts.github.io/Easygo-Address/" 
                               class="text-gray-600 hover:text-gray-900">
                                ‚Üê Back to Address
                            </a>
                            <button id="retry-payment" 
                                    class="text-blue-600 hover:text-blue-800 hidden">
                                Retry Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="text-6xl mb-6">üéâ</div>
                <h3 class="text-2xl font-bold mb-4">Payment Successful!</h3>
                <p class="text-gray-600 mb-6">Order details sent to EasyGo. Your OTP is:</p>
                
                <div class="text-4xl font-bold text-green-600 mb-6 bg-gray-100 p-4 rounded-2xl" id="generated-otp">
                    123456
                </div>
                
                <p class="text-sm text-gray-500 mb-6">
                    Share this OTP with delivery partner. Redirecting to tracking...
                </p>
                
                <button id="go-to-tracking" 
                        class="w-full py-4 bg-green-500 text-white font-bold rounded-2xl hover:bg-green-600 transition-colors">
                    Track Your Order ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="loader mx-auto mb-6"></div>
                <h3 class="text-2xl font-bold mb-4">Processing Payment</h3>
                <p class="text-gray-600 mb-6">Please wait while we connect to Razorpay...</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Freshness & Speed Delivered</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go + All Rights Reserved
                    </p>
                    <p class="text-gray-500 text-xs">
                        Serving daily from 5:00 PM to 10:00 PM
                    </p>
                    <div class="mt-4">
                        <a href="#" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="#" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="#" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<script>
    // CONFIG
    const RAZORPAY_KEY_ID = "rzp_live_RySoaT17nxFQSV";
    
    // VARIABLES
    let orderData = {};
    let finalAmount = 0;
    let paymentProcessing = false;
    
    // ERROR HANDLING
    function showError(message) {
        document.getElementById('error-text').textContent = message;
        document.getElementById('error-message').style.display = 'block';
        setTimeout(() => hideError(), 5000);
    }
    
    function hideError() {
        document.getElementById('error-message').style.display = 'none';
    }
    
    function showLoading() {
        document.getElementById('loading-modal').classList.remove('hidden');
        document.getElementById('razorpay-pay-btn').disabled = true;
    }
    
    function hideLoading() {
        document.getElementById('loading-modal').classList.add('hidden');
        document.getElementById('razorpay-pay-btn').disabled = false;
    }
    
    // LOAD ORDER DATA AND DISPLAY ON PAGE
    function loadOrderData() {
        try {
            // Load data
            const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
            const address = JSON.parse(localStorage.getItem('easygo-address') || '{}');
            const delivery = JSON.parse(localStorage.getItem('easygo-delivery') || '{}');
            
            console.log("Loaded from localStorage:", { cart, address, delivery });
            
            if (cart.length === 0) {
                showError("Cart is empty!");
                setTimeout(() => window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/', 2000);
                return;
            }
            
            // Calculate total
            let foodTotal = parseFloat(localStorage.getItem('easygo-cart-items-total')) || 0;
            if (foodTotal <= 0) {
                cart.forEach(item => foodTotal += parseFloat(item.total) || 0);
            }
            
            // Apply GST
            const gstFood = foodTotal * 0.05;
            let deliveryCharge = 0;
            let gstDelivery = 0;
            
            if ((delivery.mode || 'takeaway') === 'delivery') {
                deliveryCharge = parseFloat(delivery.charge) || 0;
                gstDelivery = deliveryCharge * 0.18;
            }
            
            finalAmount = parseFloat((foodTotal + gstFood + deliveryCharge + gstDelivery).toFixed(2));
            
            // DISPLAY CART ITEMS ON PAGE
            displayCartItems(cart);
            
            // DISPLAY CUSTOMER DETAILS ON PAGE
            displayCustomerDetails(address);
            
            // DISPLAY DELIVERY ADDRESS ON PAGE
            displayDeliveryAddress(address, delivery);
            
            // Update payment breakdown UI
            document.getElementById('food-total').textContent = `‚Çπ${foodTotal.toFixed(2)}`;
            document.getElementById('gst-food').textContent = `‚Çπ${gstFood.toFixed(2)}`;
            
            if (delivery.mode === 'delivery') {
                document.getElementById('delivery-row').classList.remove('hidden');
                document.getElementById('delivery-charge').textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
                document.getElementById('gst-delivery').textContent = `‚Çπ${gstDelivery.toFixed(2)}`;
            }
            
            document.getElementById('final-total').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
            document.getElementById('payment-amount').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
            document.getElementById('pay-amount').textContent = finalAmount.toFixed(2);
            
            // Store order data with all totals
            orderData = { 
                cart, 
                address, 
                delivery, 
                amount: finalAmount,
                totals: {
                    foodTotal: foodTotal,
                    gstFood: gstFood,
                    deliveryCharge: deliveryCharge,
                    gstDelivery: gstDelivery,
                    deliveryMode: delivery.mode || 'takeaway'
                }
            };
            
            console.log("Order data stored:", orderData);
            
        } catch (error) {
            console.error("Error:", error);
            showError("Failed to load order details");
        }
    }
    
    // DISPLAY CART ITEMS ON PAGE
    function displayCartItems(cart) {
        const orderItems = document.getElementById('order-items');
        orderItems.innerHTML = '';
        
        if (cart.length === 0) {
            orderItems.innerHTML = '<p class="text-gray-500 text-center py-4">No items in cart</p>';
            return;
        }
        
        cart.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-xl';
            itemDiv.innerHTML = `
                <div class="flex-1">
                    <p class="font-medium text-gray-800">${item.name || 'Unknown Item'}</p>
                    <div class="flex items-center gap-4 mt-1 text-sm text-gray-600">
                        <span>Qty: ${item.quantity || 1}</span>
                        <span>Pack: ${item.pack || 'Standard'}</span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-gray-900">‚Çπ${parseFloat(item.total || 0).toFixed(2)}</p>
                    <p class="text-xs text-gray-500">‚Çπ${parseFloat(item.price || 0).toFixed(2)} each</p>
                </div>
            `;
            orderItems.appendChild(itemDiv);
        });
    }
    
    // DISPLAY CUSTOMER DETAILS ON PAGE
    function displayCustomerDetails(address) {
        const customerDetails = document.getElementById('customer-details');
        customerDetails.innerHTML = '';
        
        if (!address || Object.keys(address).length === 0) {
            customerDetails.innerHTML = `
                <p class="text-red-500">‚ö†Ô∏è Customer details not found</p>
                <p class="text-sm text-gray-500">Please go back to address page and enter details</p>
            `;
            return;
        }
        
        let detailsHTML = '';
        
        if (address.name) {
            detailsHTML += `<p><span class="text-gray-600">üë§ Name:</span> <span class="font-medium">${address.name}</span></p>`;
        }
        
        if (address.phone) {
            detailsHTML += `<p><span class="text-gray-600">üì± Phone:</span> <span class="font-medium">${address.phone}</span></p>`;
        }
        
        if (address.deliveryMode) {
            const modeText = address.deliveryMode === 'delivery' ? 'Home Delivery' : 'Takeaway';
            const modeIcon = address.deliveryMode === 'delivery' ? 'üõµ' : 'üè™';
            detailsHTML += `<p><span class="text-gray-600">${modeIcon} Mode:</span> <span class="font-medium">${modeText}</span></p>`;
        }
        
        if (detailsHTML === '') {
            detailsHTML = '<p class="text-gray-500">No customer details available</p>';
        }
        
        customerDetails.innerHTML = detailsHTML;
    }
    
    // DISPLAY DELIVERY ADDRESS ON PAGE
    function displayDeliveryAddress(address, delivery) {
        const deliveryAddress = document.getElementById('delivery-address');
        deliveryAddress.innerHTML = '';
        
        const deliveryMode = address.deliveryMode || delivery.mode || 'takeaway';
        
        if (deliveryMode === 'delivery') {
            let addressHTML = '';
            
            if (address.houseNumber || address.locality) {
                // Format address for delivery
                addressHTML += `<p><span class="text-gray-600">üè† Address:</span> <span class="font-medium">${address.houseNumber || ''}, ${address.locality || ''}</span></p>`;
                
                if (address.street) {
                    addressHTML += `<p><span class="text-gray-600">üìç Street:</span> <span class="font-medium">${address.street}</span></p>`;
                }
                
                addressHTML += `<p><span class="text-gray-600">üèôÔ∏è City:</span> <span class="font-medium">${address.city || 'Indore'}, ${address.state || 'MP'} - ${address.pincode || ''}</span></p>`;
                
                if (address.addressType) {
                    addressHTML += `<p><span class="text-gray-600">üè¢ Type:</span> <span class="font-medium">${address.addressType}</span></p>`;
                }
                
                if (delivery.locationLink) {
                    addressHTML += `<p><span class="text-gray-600">üó∫Ô∏è Map:</span> <a href="${delivery.locationLink}" target="_blank" class="text-blue-600 underline">View Location</a></p>`;
                }
                
                if (delivery.distance) {
                    addressHTML += `<p><span class="text-gray-600">üìè Distance:</span> <span class="font-medium">${delivery.distance} km from restaurant</span></p>`;
                }
                
                if (delivery.charge > 0) {
                    addressHTML += `<p><span class="text-gray-600">üí∞ Delivery Fee:</span> <span class="font-medium">‚Çπ${parseFloat(delivery.charge).toFixed(2)}</span></p>`;
                }
            } else {
                addressHTML = '<p class="text-red-500">‚ö†Ô∏è Delivery address details not complete</p>';
            }
            
            deliveryAddress.innerHTML = addressHTML;
            
        } else {
            // Takeaway mode
            deliveryAddress.innerHTML = `
                <p><span class="text-gray-600">üè™ Pickup Location:</span> <span class="font-medium">Prime Square, Omaxe City 1, Indore</span></p>
                <p><span class="text-gray-600">‚è∞ Pickup Timings:</span> <span class="font-medium">6:00 PM - 10:00 PM</span></p>
                <p><span class="text-gray-600">üì± OTP Verification:</span> <span class="font-medium">Required at pickup</span></p>
                <p><span class="text-gray-600">üë§ Pickup Name:</span> <span class="font-medium">${address.name || 'Not specified'}</span></p>
                <p><span class="text-gray-600">üìû Contact:</span> <span class="font-medium">${address.phone || 'Not specified'}</span></p>
            `;
        }
    }
    
    // RAZORPAY PAYMENT
    function initiateRazorpayPayment() {
        if (paymentProcessing || !orderData.address?.phone) {
            showError("Please complete customer details first");
            return;
        }
        
        if (finalAmount < 1) {
            showError("Invalid amount");
            return;
        }
        
        showLoading();
        paymentProcessing = true;
        
        const options = {
            key: RAZORPAY_KEY_ID,
            amount: Math.round(finalAmount * 100),
            currency: "INR",
            name: "Easy Go",
            description: "Food Order Payment",
            prefill: {
                name: orderData.address.name || "Customer",
                contact: orderData.address.phone,
                email: "customer@easygo.com"
            },
            handler: function(response) {
                hideLoading();
                paymentProcessing = false;
                processPaymentSuccess(response.razorpay_payment_id);
            },
            theme: { color: "#10B981" },
            modal: {
                ondismiss: function() {
                    hideLoading();
                    paymentProcessing = false;
                }
            }
        };
        
        const rzp = new Razorpay(options);
        
        rzp.on('payment.failed', function(response) {
            hideLoading();
            paymentProcessing = false;
            showError(response.error.description || "Payment failed. Please try again.");
            document.getElementById('retry-payment').classList.remove('hidden');
        });
        
        rzp.open();
        
        // Auto hide loading after 10s
        setTimeout(() => {
            if (paymentProcessing) {
                hideLoading();
                paymentProcessing = false;
                showError("Payment timeout. Please try again.");
            }
        }, 10000);
    }
    
    // PROCESS PAYMENT SUCCESS
    function processPaymentSuccess(paymentId) {
        // Generate OTP
        const otp = Math.floor(100000 + Math.random() * 900000).toString();
        
        const deliveryMode = orderData.totals.deliveryMode || 'takeaway';
        
        // Save order with all totals
        const order = {
            id: "EG" + Date.now().toString().slice(-6),
            paymentId: paymentId,
            otp: otp,
            amount: finalAmount,
            customer: orderData.address.name,
            phone: orderData.address.phone,
            items: orderData.cart,
            deliveryMode: deliveryMode,
            totals: orderData.totals,
            address: orderData.address,
            delivery: orderData.delivery,
            timestamp: new Date().toISOString()
        };
        
        // Save order to localStorage
        let orders = JSON.parse(localStorage.getItem('easygo-orders') || '[]');
        orders.push(order);
        localStorage.setItem('easygo-orders', JSON.stringify(orders));
        
        // Save for tracking
        localStorage.setItem('easygo-otp', otp);
        localStorage.setItem('easygo-order-id', order.id);
        localStorage.setItem('easygo-delivery-mode', deliveryMode);
        
        // Clear cart (keep address and delivery for future orders)
        localStorage.removeItem('easygo-cart');
        localStorage.removeItem('easygo-cart-items-total');
        localStorage.removeItem('easygo-coupon');
        
        // Show OTP in success modal
        document.getElementById('generated-otp').textContent = otp;
        document.getElementById('success-modal').classList.remove('hidden');
        
        // Send WhatsApp message
        sendWhatsApp(order, otp);
        
        // Auto redirect to tracking after 5 seconds
        setTimeout(() => {
            if (!document.getElementById('success-modal').classList.contains('hidden')) {
                window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
            }
        }, 5000);
    }
    
    // SEND WHATSAPP MESSAGE
    function sendWhatsApp(order, otp) {
        try {
            let message = `üì¶ *NEW ORDER RECEIVED* üì¶%0A%0A`;
            
            // Basic order info
            message += `*Order ID:* ${order.id}%0A`;
            message += `*OTP:* ${otp}%0A`;
            message += `*Amount:* ‚Çπ${order.amount.toFixed(2)}%0A`;
            message += `*Payment ID:* ${order.paymentId}%0A`;
            message += `*Status:* PENDING ‚ö†Ô∏è%0A%0A`;
            
            // Items
            message += `*Items Ordered:*%0A`;
            order.items.forEach(item => {
                message += `‚Ä¢ ${item.name} √ó ${item.quantity} - ‚Çπ${item.total}%0A`;
            });
            
            message += `%0A*Payment Breakdown:*%0A`;
            message += `Food Total: ‚Çπ${order.totals?.foodTotal?.toFixed(2) || 0}%0A`;
            
            if (order.totals?.gstFood > 0) {
                message += `GST on Food (5%): ‚Çπ${order.totals.gstFood.toFixed(2)}%0A`;
            }
            
            if (order.deliveryMode === 'delivery' && order.totals?.deliveryCharge > 0) {
                message += `Delivery Charge: ‚Çπ${order.totals.deliveryCharge.toFixed(2)}%0A`;
                if (order.totals?.gstDelivery > 0) {
                    message += `GST on Delivery (18%): ‚Çπ${order.totals.gstDelivery.toFixed(2)}%0A`;
                }
            }
            
            message += `*TOTAL: ‚Çπ${order.amount.toFixed(2)}*%0A%0A`;
            
            // Customer details
            message += `*Customer Details:*%0A`;
            message += `Name: ${order.customer || 'N/A'}%0A`;
            message += `Phone: ${order.phone || 'N/A'}%0A`;
            
            // Delivery/Takeaway info
            if (order.deliveryMode === 'delivery') {
                message += `%0A*üìç Delivery Address:*%0A`;
                
                if (order.address?.houseNumber || order.address?.locality) {
                    message += `${order.address.houseNumber || ''}, ${order.address.locality || ''}%0A`;
                    if (order.address.street) message += `${order.address.street}%0A`;
                    message += `${order.address.city || 'Indore'}, ${order.address.state || 'MP'} - ${order.address.pincode || ''}%0A`;
                    
                    if (order.address.addressType) {
                        message += `Type: ${order.address.addressType}%0A`;
                    }
                }
                
                if (order.delivery?.locationLink) {
                    message += `%0Aüìç *Map Link:* ${order.delivery.locationLink}`;
                }
                
            } else {
                message += `%0A*üè™ Takeaway Pickup:*%0A`;
                message += `Prime Square, Omaxe City 1, Indore%0A`;
                message += `Timings: 6:00 PM - 10:00 PM%0A`;
                message += `Customer will pickup with OTP verification%0A`;
            }
            
            console.log("WhatsApp message:", decodeURIComponent(message));
            
            // Open WhatsApp with the message
            window.open(`https://wa.me/917651837322?text=${message}`, '_blank');
            
            // Also save to delivery system
            saveToDeliverySystem(order, otp);
            
        } catch (error) {
            console.error("Error sending WhatsApp:", error);
            // Fallback simple message
            const fallbackMsg = `New Order! Order ID: ${order.id}, OTP: ${otp}, Amount: ‚Çπ${order.amount}, Phone: ${order.phone}`;
            window.open(`https://wa.me/917651837322?text=${fallbackMsg}`, '_blank');
        }
    }
    
    // SAVE TO DELIVERY SYSTEM
    function saveToDeliverySystem(order, otp) {
        try {
            let activeOrders = JSON.parse(localStorage.getItem('easygo-active-orders')) || [];
            let allOrders = JSON.parse(localStorage.getItem('easygo-all-orders')) || [];
            
            const deliveryOrder = {
                orderId: order.id,
                razorpayPaymentId: order.paymentId,
                customerName: order.customer || order.address?.name || 'Customer',
                customerPhone: order.phone || order.address?.phone || '',
                totalAmount: order.amount,
                items: order.items.map(item => ({
                    name: item.name,
                    quantity: item.quantity,
                    price: parseFloat(item.total) || 0,
                    pack: item.pack || 'standard'
                })),
                address: order.deliveryMode === 'delivery' ? 
                    `${order.address?.houseNumber || ''}, ${order.address?.locality || ''}, ${order.address?.city || 'Indore'}` : 
                    "Takeaway - Prime Square, Omaxe City 1, Indore",
                deliveryMode: order.deliveryMode || 'takeaway',
                status: 'order-received',
                timestamp: new Date().toISOString(),
                paymentMethod: 'razorpay',
                paymentId: order.paymentId,
                otp: otp,
                deliveryPartner: "EasyGo-Rider",
                deliveryPartnerPhone: "+91 76518 37322"
            };
            
            activeOrders.push(deliveryOrder);
            localStorage.setItem('easygo-active-orders', JSON.stringify(activeOrders));
            
            allOrders.push(deliveryOrder);
            localStorage.setItem('easygo-all-orders', JSON.stringify(allOrders));
            
            console.log("Order saved to delivery system:", deliveryOrder);
            
        } catch (error) {
            console.error("Error saving to delivery system:", error);
        }
    }
    
    // EVENT LISTENERS
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderData();
        
        document.getElementById('razorpay-pay-btn').addEventListener('click', initiateRazorpayPayment);
        
        document.getElementById('go-to-tracking').addEventListener('click', function() {
            window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
        });
        
        document.getElementById('retry-payment').addEventListener('click', function() {
            document.getElementById('retry-payment').classList.add('hidden');
            initiateRazorpayPayment();
        });
        
        // Add a refresh button for testing
        const refreshBtn = document.createElement('button');
        refreshBtn.textContent = 'üîÑ Refresh Data';
        refreshBtn.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-600 z-40';
        refreshBtn.onclick = () => {
            loadOrderData();
            showError('Data refreshed!');
        };
        document.body.appendChild(refreshBtn);
    });
</script>
    
</body>
</html>
