<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <title>Easy Go | Payment</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .payment-step { transition: all 0.3s; }
        .payment-step.active { border-color: #10b981; background-color: #f0fdf4; }
        .razorpay-payment-button { display: none !important; }
        .error-message { 
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased bg-gray-50">

    <header class="relative mb-8">
        <div class="h-40 overflow-hidden">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                 class="w-full h-full object-cover" alt="Easy Go Banner">
        </div>
        <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                 class="h-20 w-20 rounded-full border-4 border-white shadow-xl bg-white p-1">
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 pt-10 pb-20">
        <!-- Error Message -->
        <div id="error-message" class="error-message fixed top-4 right-4 bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-2xl shadow-lg z-50 max-w-md">
            <div class="flex items-center">
                <div class="text-2xl mr-3">‚ö†Ô∏è</div>
                <div>
                    <h4 class="font-bold">Payment Error</h4>
                    <p id="error-text" class="text-sm mt-1"></p>
                </div>
                <button onclick="hideError()" class="ml-6 text-red-500 hover:text-red-700">‚úï</button>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="flex justify-center mb-12">
            <div class="flex items-center">
                <div class="payment-step w-12 h-12 rounded-full border-4 border-gray-300 flex items-center justify-center font-bold text-gray-500">
                    1
                </div>
                <div class="w-24 h-1 bg-gray-300"></div>
                <div class="payment-step w-12 h-12 rounded-full border-4 border-gray-300 flex items-center justify-center font-bold text-gray-500">
                    2
                </div>
                <div class="w-24 h-1 bg-gray-300"></div>
                <div class="payment-step w-12 h-12 rounded-full border-4 border-green-500 bg-green-500 text-white flex items-center justify-center font-bold">
                    3
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Order Summary -->
            <div>
                <div class="bg-white rounded-3xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold mb-6">üì¶ Order Summary</h2>
                    
                    <div id="order-items" class="space-y-4 mb-6">
                        <!-- Items loaded from localStorage -->
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="font-bold mb-4">üìù Customer Details</h3>
                        <div id="customer-details" class="space-y-2">
                            <!-- Details loaded from localStorage -->
                        </div>
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="font-bold mb-4">üìç Delivery Address</h3>
                        <div id="delivery-address" class="space-y-2">
                            <!-- Address loaded from localStorage -->
                        </div>
                    </div>
                </div>
                
                <!-- Payment Instructions -->
                <div class="bg-blue-50 border border-blue-200 rounded-3xl p-8">
                    <h3 class="font-bold text-blue-800 mb-4">üí≥ Payment Instructions</h3>
                    <ul class="space-y-2 text-blue-700">
                        <li>‚úÖ Amount is auto-calculated and cannot be edited</li>
                        <li>‚úÖ Multiple payment options available via Razorpay</li>
                        <li>‚úÖ Instant payment confirmation</li>
                        <li>‚úÖ OTP will be generated after payment</li>
                        <li>‚úÖ Refunds processed within 5 working days</li>
                        <li>‚úÖ Apply coupons available on Razorpay platform</li>
                    </ul>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div>
                <div class="bg-white rounded-3xl shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold mb-6">üí∞ Payment Bifurcation</h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between">
                            <span>Food Items Total</span>
                            <span id="food-total">‚Çπ0</span>
                        </div>
                        
                        <div id="coupon-row" class="flex justify-between text-green-600 hidden">
                            <span>Coupon Discount</span>
                            <span id="coupon-discount">-‚Çπ0</span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span>GST on Food (5%)</span>
                            <span id="gst-food">‚Çπ0</span>
                        </div>
                        
                        <div id="delivery-row" class="hidden">
                            <div class="flex justify-between">
                                <span>Delivery Charge</span>
                                <span id="delivery-charge">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>GST on Delivery (18%)</span>
                                <span id="gst-delivery">‚Çπ0</span>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <div class="flex justify-between text-xl font-bold">
                                <span>Total Amount</span>
                                <span id="final-total">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Options -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üí≥ Secure Payment</h2>
                    
                    <div class="space-y-4 mb-6">
                        <button id="razorpay-pay-btn" 
                                class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-xl font-bold rounded-2xl hover:opacity-90 transition-opacity flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.436 7.406H1.564a1.25 1.25 0 0 0-1.108 1.831l1.414 2.823a1.25 1.25 0 0 0 1.108.669h19.242a1.25 1.25 0 0 0 1.108-.669l1.414-2.823a1.25 1.25 0 0 0-1.108-1.831z"/>
                                <path d="M2.5 12.406h19v9h-19z"/>
                            </svg>
                            Pay with Razorpay - ‚Çπ<span id="pay-amount">0</span>
                        </button>
                        
                        <div class="text-center text-sm text-gray-500 mb-4">
                            Powered by Razorpay - Accepts Cards, UPI, NetBanking & Wallets
                        </div>
                    </div>
                    
                    <div class="text-center mb-6">
                        <p class="text-3xl font-bold text-blue-600 mb-2" id="payment-amount">‚Çπ0</p>
                        <p class="text-gray-600 text-sm">Final amount payable</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <a href="https://clean-scripts.github.io/Easygo-Address/" 
                               class="text-gray-600 hover:text-gray-900">
                                ‚Üê Back to Address
                            </a>
                            <button id="retry-payment" 
                                    class="text-blue-600 hover:text-blue-800 hidden">
                                Retry Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="text-6xl mb-6">üéâ</div>
                <h3 class="text-2xl font-bold mb-4">Payment Successful!</h3>
                <p class="text-gray-600 mb-6">Order details sent to EasyGo. Your OTP is:</p>
                
                <div class="text-4xl font-bold text-green-600 mb-6 bg-gray-100 p-4 rounded-2xl" id="generated-otp">
                    123456
                </div>
                
                <p class="text-sm text-gray-500 mb-6">
                    Share this OTP with delivery partner. Redirecting to tracking...
                </p>
                
                <button id="go-to-tracking" 
                        class="w-full py-4 bg-green-500 text-white font-bold rounded-2xl hover:bg-green-600 transition-colors">
                    Track Your Order ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="text-6xl mb-6 animate-pulse">‚è≥</div>
                <h3 class="text-2xl font-bold mb-4">Processing Payment</h3>
                <p class="text-gray-600 mb-6">Please wait while we connect to Razorpay...</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full animate-pulse w-3/4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Freshness & Speed Delivered</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go + All Rights Reserved
                    </p>
                    <p class="text-gray-500 text-xs">
                        MORE | PISA | ICRT Registered - Serving daily from 5:00 PM to 10:00 PM
                    </p>
                    <div class="mt-4">
                        <a href="#" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="#" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="#" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ============================
        // CONFIGURATION
        // ============================
        // Use test key for development
        // For production, replace with your live key
        const RAZORPAY_KEY_ID = "rzp_live_RySoaT17nxFQSV"; // Test key - replace with your live key

        // ============================
        // GLOBAL VARIABLES
        // ============================
        let orderData = {};
        let finalAmount = 0;
        let otp = '';
        let paymentProcessing = false;

        // ============================
        // ERROR HANDLING
        // ============================
        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('retry-payment').classList.remove('hidden');
            
            // Auto hide after 8 seconds
            setTimeout(() => {
                hideError();
            }, 8000);
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loading-modal').classList.remove('hidden');
            paymentProcessing = true;
            document.getElementById('razorpay-pay-btn').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loading-modal').classList.add('hidden');
            paymentProcessing = false;
            document.getElementById('razorpay-pay-btn').disabled = false;
        }

        // ============================
        // INITIALIZATION
        // ============================
        function loadOrderData() {
            try {
                // Load cart
                const cart = JSON.parse(localStorage.getItem('easygo-cart')) || [];
                
                if (cart.length === 0) {
                    showError("Your cart is empty. Please add items first.");
                    setTimeout(() => {
                        window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
                    }, 2000);
                    return;
                }
                
                // Load address and delivery data
                const address = JSON.parse(localStorage.getItem('easygo-address')) || {};
                const delivery = JSON.parse(localStorage.getItem('easygo-delivery')) || {};
                const coupon = JSON.parse(localStorage.getItem('easygo-coupon')) || null;
                
                // Validate address for delivery
                if (delivery.mode === 'delivery' && (!address.phone || !address.houseNumber)) {
                    showError("Please complete address details first.");
                    setTimeout(() => {
                        window.location.href = 'https://clean-scripts.github.io/Easygo-Address/';
                    }, 2000);
                    return;
                }
                
                // Calculate totals
                let foodTotal = parseFloat(localStorage.getItem('easygo-cart-total')) || 0;
                let discount = 0;
                
                if (coupon) {
                    if (coupon.type === 'percent') {
                        discount = foodTotal * (coupon.discount / 100);
                    } else {
                        discount = coupon.discount;
                    }
                    discount = Math.min(discount, foodTotal); // Prevent negative
                    document.getElementById('coupon-row').classList.remove('hidden');
                    document.getElementById('coupon-discount').textContent = `-‚Çπ${discount.toFixed(2)}`;
                }
                
                const foodAfterDiscount = foodTotal - discount;
                const gstFood = foodAfterDiscount * 0.05;
                
                let deliveryCharge = 0;
                let gstDelivery = 0;
                
                if (delivery.mode === 'delivery') {
                    deliveryCharge = parseFloat(delivery.charge) || 30; // Default delivery charge
                    gstDelivery = deliveryCharge * 0.18;
                    document.getElementById('delivery-row').classList.remove('hidden');
                    document.getElementById('delivery-charge').textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
                    document.getElementById('gst-delivery').textContent = `‚Çπ${gstDelivery.toFixed(2)}`;
                }
                
                finalAmount = Math.round(foodAfterDiscount + gstFood + deliveryCharge + gstDelivery);
                
                // Validate amount
                if (finalAmount <= 0) {
                    showError("Invalid order amount. Please check your cart.");
                    return;
                }
                
                // Update UI
                document.getElementById('food-total').textContent = `‚Çπ${foodTotal.toFixed(2)}`;
                document.getElementById('gst-food').textContent = `‚Çπ${gstFood.toFixed(2)}`;
                document.getElementById('final-total').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
                document.getElementById('payment-amount').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
                document.getElementById('pay-amount').textContent = finalAmount.toFixed(2);
                
                // Render items
                renderOrderItems(cart);
                
                // Render details
                renderDetails(address, delivery);
                
                // Store order data
                orderData = {
                    cart: cart,
                    address: address,
                    delivery: delivery,
                    coupon: coupon,
                    totals: {
                        foodTotal: foodTotal,
                        discount: discount,
                        gstFood: gstFood,
                        deliveryCharge: deliveryCharge,
                        gstDelivery: gstDelivery,
                        finalAmount: finalAmount
                    }
                };
                
            } catch (error) {
                console.error("Error loading order data:", error);
                showError("Failed to load order details. Please refresh the page.");
            }
        }
        
        function renderOrderItems(cart) {
            const container = document.getElementById('order-items');
            let html = '';
            
            cart.forEach(item => {
                html += `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.quantity} √ó ${getPackName(item.pack)}</p>
                        </div>
                        <span class="font-bold">‚Çπ${item.total}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getPackName(pack) {
            const names = {
                'piece': 'Piece',
                'standard': 'Standard',
                'family': 'Family Pack',
                'xl': 'Extra Large'
            };
            return names[pack] || pack;
        }
        
        function renderDetails(address, delivery) {
            // Customer details
            const customerDiv = document.getElementById('customer-details');
            customerDiv.innerHTML = `
                <p><strong>Name:</strong> ${address.name || 'Not provided'}</p>
                <p><strong>Phone:</strong> ${address.phone || 'Not provided'}</p>
            `;
            
            // Address
            const addressDiv = document.getElementById('delivery-address');
            if (delivery.mode === 'delivery') {
                addressDiv.innerHTML = `
                    <p><strong>üìç Delivery Address:</strong></p>
                    <p>${address.houseNumber || ''}, ${address.locality || ''}</p>
                    <p>${address.street || ''}</p>
                    <p>${address.city || ''}, ${address.state || ''} - ${address.pincode || ''}</p>
                    ${address.specialRequest ? `<p><strong>Special Request:</strong> ${address.specialRequest}</p>` : ''}
                    ${delivery.locationLink ? `
                        <p class="text-sm text-blue-600 mt-2">
                            <a href="${delivery.locationLink}" target="_blank" class="underline">View Location on Map</a>
                        </p>
                    ` : ''}
                `;
            } else {
                addressDiv.innerHTML = `
                    <p><strong>üõçÔ∏è Takeaway Pickup:</strong></p>
                    <p>Prime Square, Omaxe City 1, Indore</p>
                    <p>Timings: 6:00 PM - 10:00 PM</p>
                    <p class="text-sm text-green-600 mt-2">
                        Order will be ready in 20-25 minutes
                    </p>
                `;
            }
        }
        
        // ============================
        // OTP GENERATION
        // ============================
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        // ============================
        // RAZORPAY INTEGRATION
        // ============================
        function initiateRazorpayPayment() {
            if (paymentProcessing) return;
            
            // Validate data
            if (!orderData || !orderData.address || !orderData.address.phone) {
                showError("Please complete your details first.");
                return;
            }
            
            if (finalAmount <= 0) {
                showError("Invalid order amount. Please check your cart.");
                return;
            }
            
            showLoading();
            
            try {
                // Generate unique order ID for Razorpay
                const razorpayOrderId = "order_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                
                const options = {
                    key: RAZORPAY_KEY_ID,
                    amount: finalAmount * 100, // Amount in paise
                    currency: "INR",
                    name: "Easy Go Food Delivery",
                    description: "Order Payment",
                    order_id: razorpayOrderId, // This will be overridden if you have backend
                    
                    // Customer details
                    prefill: {
                        name: orderData.address.name || "Customer",
                        contact: orderData.address.phone || "",
                        email: orderData.address.email || "customer@example.com"
                    },
                    
                    // Theme
                    theme: {
                        color: "#10B981"
                    },
                    
                    // Callback functions
                    handler: function(response) {
                        hideLoading();
                        console.log("Payment successful:", response);
                        handlePaymentSuccess(response.razorpay_payment_id, "razorpay", response.razorpay_order_id);
                    },
                    
                    modal: {
                        ondismiss: function() {
                            hideLoading();
                            console.log("Payment modal closed by user");
                        }
                    },
                    
                    "notes": {
                        "order_type": orderData.delivery.mode,
                        "customer_name": orderData.address.name,
                        "customer_phone": orderData.address.phone
                    }
                };
                
                // Create and open Razorpay instance
                const rzp = new Razorpay(options);
                
                // Handle errors
                rzp.on('payment.failed', function(response) {
                    hideLoading();
                    console.error("Payment failed:", response.error);
                    showError("Payment failed: " + (response.error.description || "Unknown error"));
                });
                
                // Open payment modal with delay to ensure loading shows
                setTimeout(() => {
                    rzp.open();
                }, 500);
                
            } catch (error) {
                hideLoading();
                console.error("Razorpay initialization error:", error);
                showError("Failed to initialize payment. Please try again.");
            }
        }
        
        // ============================
        // ORDER MANAGEMENT
        // ============================
        function saveOrderToAdmin(orderData, otp, paymentMethod, paymentId = null, razorpayOrderId = null) {
            try {
                // Get active orders
                let activeOrders = JSON.parse(localStorage.getItem('easygo-active-orders')) || [];
                
                // Create order object
                const adminOrder = {
                    orderId: "EG" + Date.now().toString().slice(-8),
                    razorpayOrderId: razorpayOrderId,
                    customerName: orderData.address.name,
                    customerPhone: orderData.address.phone,
                    totalAmount: orderData.totals.finalAmount,
                    items: orderData.cart.map(item => ({
                        name: item.name,
                        quantity: item.quantity,
                        price: item.total,
                        pack: item.pack
                    })),
                    address: orderData.delivery.mode === 'delivery' ? 
                        `${orderData.address.houseNumber}, ${orderData.address.locality}, ${orderData.address.city}` : 
                        "Takeaway - Prime Square, Indore",
                    locationLink: orderData.delivery.locationLink || "",
                    deliveryMode: orderData.delivery.mode,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    paymentMethod: paymentMethod,
                    paymentId: paymentId,
                    otp: otp
                };
                
                // Add to active orders
                activeOrders.push(adminOrder);
                localStorage.setItem('easygo-active-orders', JSON.stringify(activeOrders));
                
                // Also save to all orders history
                let allOrders = JSON.parse(localStorage.getItem('easygo-all-orders')) || [];
                allOrders.push(adminOrder);
                localStorage.setItem('easygo-all-orders', JSON.stringify(allOrders));
                
                return adminOrder;
                
            } catch (error) {
                console.error("Error saving order:", error);
                throw error;
            }
        }
        
        function sendWhatsAppMessage(orderData, otp, adminOrder, paymentMethod) {
            try {
                let message = `üì¶ *NEW ORDER RECEIVED* üì¶%0A%0A`;
                message += `*Order ID:* ${adminOrder.orderId}%0A`;
                message += `*OTP:* ${otp}%0A`;
                message += `*Payment Method:* ${paymentMethod.toUpperCase()}%0A`;
                message += `*Status:* PENDING ‚ö†Ô∏è%0A%0A`;
                
                // Add items
                message += `*Items:*%0A`;
                orderData.cart.forEach(item => {
                    message += `‚Ä¢ ${item.name} (${getPackName(item.pack)}) √ó ${item.quantity} - ‚Çπ${item.total}%0A`;
                });
                
                message += `%0A*Totals:*%0A`;
                message += `Food Total: ‚Çπ${orderData.totals.foodTotal.toFixed(2)}%0A`;
                if (orderData.totals.discount > 0) {
                    message += `Discount: -‚Çπ${orderData.totals.discount.toFixed(2)}%0A`;
                }
                message += `GST on Food: ‚Çπ${orderData.totals.gstFood.toFixed(2)}%0A`;
                if (orderData.delivery.mode === 'delivery') {
                    message += `Delivery: ‚Çπ${orderData.totals.deliveryCharge.toFixed(2)}%0A`;
                    message += `GST on Delivery: ‚Çπ${orderData.totals.gstDelivery.toFixed(2)}%0A`;
                }
                message += `*TOTAL: ‚Çπ${orderData.totals.finalAmount.toFixed(2)}*%0A%0A`;
                
                // Customer details
                message += `*Customer Details:*%0A`;
                message += `Name: ${orderData.address.name}%0A`;
                message += `Phone: ${orderData.address.phone}%0A%0A`;
                
                // Delivery/Takeaway info
                if (orderData.delivery.mode === 'delivery') {
                    message += `*Delivery Address:*%0A`;
                    message += `${orderData.address.houseNumber}, ${orderData.address.locality}%0A`;
                    message += `${orderData.address.street}%0A`;
                    message += `${orderData.address.city}, ${orderData.address.state} - ${orderData.address.pincode}%0A`;
                    
                    if (orderData.address.specialRequest) {
                        message += `%0A*Special Request:* ${orderData.address.specialRequest}%0A`;
                    }
                    
                    // Location link
                    if (orderData.delivery.locationLink) {
                        message += `%0Aüìç *Location Link:* ${orderData.delivery.locationLink}`;
                    }
                } else {
                    message += `*Takeaway Pickup:*%0A`;
                    message += `Prime Square, Omaxe City 1, Indore%0A`;
                    message += `Customer will pickup order%0A`;
                }
                
                // Open WhatsApp
                window.open(`https://wa.me/917651837322?text=${message}`, '_blank');
                
            } catch (error) {
                console.error("Error sending WhatsApp message:", error);
            }
        }
        
        // ============================
        // PAYMENT HANDLERS
        // ============================
        function handlePaymentSuccess(paymentId = null, paymentMethod = "razorpay", razorpayOrderId = null) {
            try {
                otp = generateOTP();
                
                // Save order to admin system
                const adminOrder = saveOrderToAdmin(orderData, otp, paymentMethod, paymentId, razorpayOrderId);
                
                // Send WhatsApp message
                sendWhatsAppMessage(orderData, otp, adminOrder, paymentMethod);
                
                // Show OTP modal
                document.getElementById('generated-otp').textContent = otp;
                document.getElementById('success-modal').classList.remove('hidden');
                
                // Save OTP to localStorage for tracking page
                localStorage.setItem('easygo-otp', otp);
                localStorage.setItem('easygo-order-id', adminOrder.orderId);
                
                // Clear cart data
                localStorage.removeItem('easygo-cart');
                localStorage.removeItem('easygo-cart-total');
                localStorage.removeItem('easygo-coupon');
                localStorage.removeItem('easygo-delivery');
                
                // Auto redirect after 5 seconds
                setTimeout(() => {
                    if (!document.getElementById('success-modal').classList.contains('hidden')) {
                        window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
                    }
                }, 5000);
                
            } catch (error) {
                console.error("Error handling payment success:", error);
                showError("Order saved but encountered an error. Please note your OTP: " + otp);
            }
        }
        
        // ============================
        // EVENT LISTENERS
        // ============================
        document.getElementById('razorpay-pay-btn').addEventListener('click', initiateRazorpayPayment);
        
        document.getElementById('retry-payment').addEventListener('click', () => {
            hideError();
            initiateRazorpayPayment();
        });
        
        document.getElementById('go-to-tracking').addEventListener('click', () => {
            window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
        });
        
        // Close modals on outside click
        document.getElementById('success-modal').addEventListener('click', (e) => {
            if (e.target.id === 'success-modal') {
                e.target.classList.add('hidden');
            }
        });
        
        document.getElementById('loading-modal').addEventListener('click', (e) => {
            if (e.target.id === 'loading-modal') {
                e.target.classList.add('hidden');
                hideLoading();
            }
        });
        
        // ============================
        // INITIALIZE
        // ============================
        window.addEventListener('DOMContentLoaded', loadOrderData);
        
        // Handle Enter key
        document.addEventListener('keyup', (e) => {
            if (e.key === 'Enter' && !paymentProcessing) {
                initiateRazorpayPayment();
            }
        });
    </script>
</body>
</html>
