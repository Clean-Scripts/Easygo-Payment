<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Go | Secure Payment</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Your existing HTML structure -->
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
            authDomain: "easygo-10f4b.firebasestorage.app",
            projectId: "easygo-10f4b",
            storageBucket: "easygo-10f4b.firebasestorage.app",
            messagingSenderId: "197660067542",
            appId: "1:197660067542:web:6c616efb479b122f1f6b77",
            databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        
        let database;
        let isFirebaseConnected = false;
        
        function initializeFirebase() {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    isFirebaseConnected = snap.val() === true;
                });
            } catch (error) {
                console.error("Firebase error:", error);
            }
        }
        
        // Save order to Firebase
        async function saveOrderToFirebase(orderData) {
            if (!isFirebaseConnected) return null;
            
            try {
                const orderRef = database.ref('orders').push();
                await orderRef.set({
                    ...orderData,
                    createdAt: Date.now(),
                    date: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
                    status: 'pending',
                    paymentStatus: 'pending'
                });
                
                return orderRef.key;
            } catch (error) {
                console.error("Error saving order:", error);
                return null;
            }
        }
        
        // Update payment status
        async function updatePaymentStatus(orderId, paymentData) {
            if (!isFirebaseConnected) return false;
            
            try {
                await database.ref(`orders/${orderId}`).update({
                    paymentStatus: paymentData.status,
                    paymentId: paymentData.paymentId,
                    razorpayPaymentId: paymentData.razorpayPaymentId,
                    paymentUpdatedAt: Date.now()
                });
                return true;
            } catch (error) {
                console.error("Error updating payment:", error);
                return false;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            
            // Update your existing payment success handler
            function handlePaymentSuccess(paymentId) {
                // Your existing logic
                const orderData = {
                    // Your order data
                };
                
                // Save to Firebase
                saveOrderToFirebase(orderData).then(firebaseOrderId => {
                    if (firebaseOrderId) {
                        // Update payment status
                        updatePaymentStatus(firebaseOrderId, {
                            status: 'success',
                            paymentId: paymentId,
                            razorpayPaymentId: paymentId
                        });
                        
                        // Store Firebase order ID in localStorage
                        localStorage.setItem('easygo-firebase-order-id', firebaseOrderId);
                    }
                });
                
                // Continue with existing logic
            }
        });
    </script>
</body>
</html>
