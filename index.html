<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/Easygo-Address/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <title>Easy Go | Secure Payment</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .razorpay-payment-button { display: none !important; }
        
        /* Notification Cards */
        .notification-card {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .notification-card.show {
            transform: translateX(0);
        }
        
        /* Simple Alert Card */
        .alert-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .alert-card.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: all;
        }
        
        /* Alert Overlay */
        .alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .alert-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .payment-success {
            animation: successPulse 2s infinite;
        }
        
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Loading spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

    <!-- Header Banner -->
    <header class="relative mb-8">
        <div class="h-40 overflow-hidden">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                 class="w-full h-full object-cover" alt="Easy Go Banner">
        </div>
        <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                 class="h-20 w-20 rounded-full border-4 border-white shadow-xl bg-white p-1">
        </div>
    </header>

    <!-- Success Alert Card -->
    <div class="alert-card" id="success-alert">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl border-2 border-green-200">
            <div class="text-center">
                <div class="text-6xl mb-6">‚úÖ</div>
                <h3 class="text-2xl font-bold mb-4">Payment Successful!</h3>
                <p class="text-gray-600 mb-6">Order confirmed. Please save this OTP:</p>
                
                <div class="text-4xl font-bold text-green-600 mb-6 bg-gray-100 p-4 rounded-2xl payment-success" id="generated-otp">
                    XXX XXX
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-2xl p-4 mb-6">
                    <p class="text-sm text-green-800">
                        <strong>WhatsApp Sent!</strong> Order details sent to EasyGo outlet.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <button onclick="goToTracking()" 
                            class="w-full py-4 bg-blue-500 text-white font-bold rounded-2xl hover:bg-blue-600 transition-colors shadow-lg hover:shadow-xl">
                        Track Your Order ‚Üí
                    </button>
                    <button onclick="viewWhatsAppMessage()" 
                            class="w-full py-3 bg-green-500 text-white font-bold rounded-2xl hover:bg-green-600 transition-colors">
                        üì± View WhatsApp Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Alert Card -->
    <div class="alert-card" id="error-alert">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl border-2 border-red-200">
            <div class="text-center">
                <div class="text-6xl mb-6">‚ö†Ô∏è</div>
                <h3 class="text-2xl font-bold mb-4" id="error-title">Payment Failed</h3>
                <p class="text-gray-600 mb-6" id="error-message">Payment could not be processed.</p>
                
                <div class="bg-red-50 border border-red-200 rounded-2xl p-4 mb-6">
                    <p class="text-red-800 mb-3" id="error-details"></p>
                    <p class="text-sm text-red-700">
                        <strong>Note:</strong> If amount was deducted, it will be refunded within 24-48 hours.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <button onclick="closeAlert('error-alert'); initiatePayment();" 
                            class="w-full py-4 bg-blue-500 text-white font-bold rounded-2xl hover:bg-blue-600 transition-colors shadow-lg">
                        Try Payment Again
                    </button>
                    
                    <button onclick="closeAlert('error-alert')" 
                            class="w-full py-3 bg-gray-200 text-gray-800 rounded-2xl hover:bg-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Out of Range Alert -->
    <div class="alert-card" id="range-alert">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl border-2 border-orange-200">
            <div class="text-center">
                <div class="text-6xl mb-6">üìç</div>
                <h3 class="text-2xl font-bold mb-4">Delivery Not Available</h3>
                <p class="text-gray-600 mb-6" id="range-message"></p>
                
                <div class="bg-orange-50 border border-orange-200 rounded-2xl p-4 mb-6">
                    <p class="text-sm text-orange-800">
                        <strong>Current Delivery Range:</strong> Up to 10km from outlet only.
                    </p>
                </div>
                
                <button onclick="closeAlert('range-alert'); window.history.back();" 
                        class="w-full py-4 bg-blue-500 text-white font-bold rounded-2xl hover:bg-blue-600 transition-colors shadow-lg">
                    ‚Üê Back to Address
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Inline -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-6"></div>
                <h3 class="text-2xl font-bold mb-4">Processing Payment</h3>
                <p class="text-gray-600">Please wait...</p>
            </div>
        </div>
    </div>

    <!-- Alert Overlay -->
    <div class="alert-overlay" id="alert-overlay" onclick="closeAllAlerts()"></div>

    <!-- Notification Cards -->
    <div class="notification-card" id="success-notification">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-2xl shadow-xl max-w-sm">
            <div class="flex items-center gap-4">
                <div class="text-3xl">‚úÖ</div>
                <div>
                    <h4 class="font-bold text-lg">Payment Successful!</h4>
                    <p class="text-green-100 text-sm">Order confirmed. OTP generated.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="notification-card" id="error-notification">
        <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-6 rounded-2xl shadow-xl max-w-sm">
            <div class="flex items-center gap-4">
                <div class="text-3xl">‚ùå</div>
                <div>
                    <h4 class="font-bold text-lg">Payment Failed</h4>
                    <p class="text-red-100 text-sm" id="error-notification-msg">Please try again</p>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 pt-10 pb-20">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Order Summary -->
            <div class="space-y-8">
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="mr-3">üì¶</span>
                        Order Summary
                    </h2>
                    
                    <div id="order-items" class="space-y-4 mb-6 max-h-80 overflow-y-auto pr-2">
                        <!-- Items loaded from localStorage -->
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="font-bold mb-4 flex items-center">
                            <span class="mr-2">üë§</span>
                            Customer Details
                        </h3>
                        <div id="customer-details" class="space-y-2">
                            <!-- Details loaded from localStorage -->
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <h3 class="font-bold mb-4 flex items-center">
                        <span class="mr-2">üìç</span>
                        Order Details
                    </h3>
                    <div id="delivery-address" class="space-y-2">
                        <!-- Address loaded from localStorage -->
                    </div>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div class="space-y-8">
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="mr-3">üí∞</span>
                        Payment Summary
                    </h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between py-2">
                            <span class="text-gray-700">Food Items Total</span>
                            <span id="food-total" class="font-semibold">‚Çπ0</span>
                        </div>
                        
                        <div class="flex justify-between py-2">
                            <span class="text-gray-700">GST on Food (5%)</span>
                            <span id="gst-food" class="font-semibold">‚Çπ0</span>
                        </div>
                        
                        <!-- Delivery Charges Section -->
                        <div id="delivery-section" class="border-t pt-4 mt-2">
                            <div class="flex justify-between py-2">
                                <span class="text-gray-700">Delivery Charge</span>
                                <span id="delivery-charge" class="font-semibold">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-700">GST on Delivery</span>
                                <span id="gst-delivery" class="font-semibold">‚Çπ0</span>
                            </div>
                            <p id="delivery-note" class="text-xs text-gray-500 mt-1 text-right">
                                <span id="delivery-info"></span>
                            </p>
                        </div>
                        
                        <div class="border-t-2 border-gray-300 pt-4 mt-2">
                            <div class="flex justify-between text-xl font-bold py-2">
                                <span class="text-gray-800">Total Amount Payable</span>
                                <span id="final-total" class="text-green-600">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Options -->
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <div class="text-center mb-8">
                        <div class="inline-block bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 text-green-800 px-8 py-4 rounded-2xl mb-4">
                            <div class="text-sm font-medium mb-1">Total to pay</div>
                            <span class="font-bold text-3xl" id="payment-amount">‚Çπ0</span>
                        </div>
                        <p class="text-gray-600">100% Secure Payment via Razorpay</p>
                    </div>
                    
                    <div class="space-y-4 mb-8">
                        <button id="razorpay-pay-btn" 
                                class="w-full py-5 bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-xl font-bold rounded-2xl hover:from-blue-700 hover:to-indigo-800 transition-all duration-300 transform hover:-translate-y-0.5 shadow-xl hover:shadow-2xl flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none"
                                onclick="initiatePayment()">
                            <svg class="w-7 h-7 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.436 7.406H1.564a1.25 1.25 0 0 0-1.108 1.831l1.414 2.823a1.25 1.25 0 0 0 1.108.669h19.242a1.25 1.25 0 0 0 1.108-.669l1.414-2.823a1.25 1.25 0 0 0-1.108-1.831z"/>
                                <path d="M2.5 12.406h19v9h-19z"/>
                            </svg>
                            Pay Now - ‚Çπ<span id="pay-amount">0</span>
                        </button>
                        
                        <div class="text-center pt-4">
                            <div class="inline-flex items-center justify-center space-x-3 text-sm text-gray-600 bg-gray-50 px-6 py-3 rounded-full">
                                <span class="flex items-center">
                                    <span class="text-green-500 mr-1">‚úì</span>
                                    Secure
                                </span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>Cards</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>UPI</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>NetBanking</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Powered by Razorpay | PCI DSS Certified</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 pt-6 border-t">
                        <div class="flex justify-between items-center">
                            <a href="https://clean-scripts.github.io/Easygo-Address/" 
                               class="text-gray-600 hover:text-gray-900 flex items-center group transition-colors">
                                <span class="text-xl mr-2 group-hover:-translate-x-1 transition-transform">‚Üê</span>
                                <span>Back to Address</span>
                            </a>
                            <button id="retry-payment" 
                                    class="text-blue-600 hover:text-blue-800 hidden flex items-center group"
                                    onclick="initiatePayment()">
                                <span class="mr-2 group-hover:rotate-180 transition-transform">üîÑ</span>
                                <span>Retry Payment</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Delivering Freshness & Speed !</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go | All Rights Reserved
                    </p>
                    <p class="text-gray-500 text-xs">
                        Serving daily from 5:45 PM to 10:30 PM
                    </p>
                    <div class="mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<script>
    // CONFIGURATION
    const RAZORPAY_KEY_ID = "rzp_live_RySoaT17nxFQSV";
    const RESTAURANT_PHONE = "917651837322"; // YOUR NUMBER
    
    // GLOBAL STATE
    let orderData = {};
    let finalAmount = 0;
    let paymentProcessing = false;
    let currentOrder = null;
    
    // ALERT FUNCTIONS
    function showAlert(alertId) {
        document.getElementById(alertId).classList.add('active');
        document.getElementById('alert-overlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeAlert(alertId) {
        document.getElementById(alertId).classList.remove('active');
        document.getElementById('alert-overlay').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function closeAllAlerts() {
        document.querySelectorAll('.alert-card').forEach(alert => {
            alert.classList.remove('active');
        });
        document.getElementById('alert-overlay').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function showNotification(type, message = '') {
        const notificationId = type === 'success' ? 'success-notification' : 'error-notification';
        const notification = document.getElementById(notificationId);
        
        if (message && type === 'error') {
            document.getElementById('error-notification-msg').textContent = message.substring(0, 50);
        }
        
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    function showLoading() {
        document.getElementById('loading-indicator').classList.remove('hidden');
    }
    
    function hideLoading() {
        document.getElementById('loading-indicator').classList.add('hidden');
    }
    
    // LOAD ORDER DATA FROM ADDRESS PAGE
    function loadOrderData() {
        try {
            const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
            const address = JSON.parse(localStorage.getItem('easygo-address') || '{}');
            const delivery = JSON.parse(localStorage.getItem('easygo-delivery') || '{}');
            
            if (cart.length === 0) {
                showAlert('range-alert');
                document.getElementById('range-message').textContent = 'Your cart is empty. Redirecting to menu...';
                setTimeout(() => {
                    window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
                }, 3000);
                return false;
            }
            
            // Get delivery mode from address page
            const deliveryMode = address.deliveryMode || 'takeaway';
            
            // Calculate food total
            let foodTotal = 0;
            cart.forEach(item => {
                const unitPrice = parseFloat(item.unitPrice) || 0;
                const quantity = parseInt(item.quantity) || 1;
                const itemTotal = unitPrice * quantity;
                foodTotal += itemTotal || 0;
            });
            
            if (foodTotal <= 0) {
                foodTotal = parseFloat(localStorage.getItem('easygo-cart-items-total')) || 0;
            }
            
            if (foodTotal <= 0) {
                showNotification('error', 'Invalid order amount');
                return false;
            }
            
            const gstFood = Math.round((foodTotal * 0.05) * 100) / 100;
            
            // DELIVERY CHARGES LOGIC FROM ADDRESS PAGE
            let deliveryCharge = 0;
            let gstDelivery = 0;
            let deliveryInfo = "";
            
            if (deliveryMode === 'delivery') {
                const distance = parseFloat(delivery.distance) || 0;
                const cartTotal = foodTotal;
                
                // CHECK IF BEYOND 10KM
                if (distance > 10) {
                    showAlert('range-alert');
                    document.getElementById('range-message').textContent = `Your location (${distance.toFixed(1)}km) is beyond our 10km delivery range.`;
                    return false;
                }
                
                // 1KM FIXED ‚Çπ9 DELIVERY (NO EXTRA GST)
                if (distance <= 1) {
                    deliveryCharge = 9;
                    deliveryInfo = "Fixed ‚Çπ9 delivery (GST included)";
                    gstDelivery = 0;
                }
                // FREE DELIVERY FOR ORDERS ABOVE ‚Çπ199 WITHIN 4KM
                else if (distance <= 4 && cartTotal > 199) {
                    deliveryCharge = 0;
                    deliveryInfo = "Free delivery (order above ‚Çπ199)";
                    gstDelivery = 0;
                }
                // STANDARD DELIVERY CHARGES
                else {
                    let charge = 0;
                    if (distance <= 4) {
                        charge = distance * 6; // ‚Çπ6 per km
                    }
                    else if (distance <= 8) {
                        charge = (4 * 6) + ((distance - 4) * 8); // ‚Çπ8 per km for 4-8km
                    }
                    else if (distance <= 10) {
                        charge = (4 * 6) + (4 * 8) + ((distance - 8) * 10); // ‚Çπ10 per km for 8-10km
                    }
                    
                    deliveryCharge = Math.ceil(charge);
                    // Add 18% GST on delivery (except for ‚Çπ9 delivery)
                    gstDelivery = Math.round((deliveryCharge * 0.18) * 100) / 100;
                    deliveryInfo = `${distance.toFixed(1)}km delivery`;
                }
            }
            
            finalAmount = parseFloat((foodTotal + gstFood + deliveryCharge + gstDelivery).toFixed(2));
            
            if (finalAmount < 1) {
                showNotification('error', 'Invalid total amount');
                return false;
            }
            
            displayCartItems(cart);
            displayCustomerDetails(address, deliveryMode);
            displayDeliveryAddress(address, delivery, deliveryMode);
            updatePaymentUI(foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode, deliveryInfo);
            
            orderData = { 
                cart, 
                address, 
                delivery, 
                amount: finalAmount,
                totals: {
                    foodTotal,
                    gstFood,
                    deliveryCharge,
                    gstDelivery,
                    deliveryMode,
                    distance: delivery.distance
                }
            };
            
            console.log("Order loaded:", orderData);
            return true;
            
        } catch (error) {
            console.error("Error loading order:", error);
            showNotification('error', 'Failed to load order');
            return false;
        }
    }
    
    function updatePaymentUI(foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode, deliveryInfo) {
        document.getElementById('food-total').textContent = `‚Çπ${foodTotal.toFixed(2)}`;
        document.getElementById('gst-food').textContent = `‚Çπ${gstFood.toFixed(2)}`;
        
        if (deliveryMode === 'delivery') {
            document.getElementById('delivery-section').classList.remove('hidden');
            document.getElementById('delivery-charge').textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
            
            if (deliveryCharge === 9) {
                document.getElementById('gst-delivery').textContent = '‚Çπ0.00 (Included in ‚Çπ9)';
            } else {
                document.getElementById('gst-delivery').textContent = `‚Çπ${gstDelivery.toFixed(2)}`;
            }
            
            document.getElementById('delivery-info').textContent = deliveryInfo;
        } else {
            document.getElementById('delivery-section').classList.add('hidden');
        }
        
        document.getElementById('final-total').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
        document.getElementById('payment-amount').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
        document.getElementById('pay-amount').textContent = finalAmount.toFixed(2);
    }
    
    // DISPLAY FUNCTIONS
    function displayCartItems(cart) {
        const orderItems = document.getElementById('order-items');
        if (!orderItems) return;
        
        orderItems.innerHTML = '';
        
        cart.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-xl border border-gray-100 fade-in';
            
            const quantity = parseInt(item.quantity) || 1;
            const unitPrice = parseFloat(item.unitPrice) || 0;
            const totalPrice = unitPrice * quantity;
            
            itemDiv.innerHTML = `
                <div class="flex-1">
                    <p class="font-semibold text-gray-800 text-lg">${item.name || 'Food Item'}</p>
                    <div class="flex items-center gap-4 mt-2">
                        <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">Qty: ${quantity}</span>
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">Pack: ${item.pack || 'Family'}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">‚Çπ${unitPrice.toFixed(2)} √ó ${quantity}</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 mb-1">Price</div>
                    <div class="text-lg font-bold text-gray-800">‚Çπ${totalPrice.toFixed(2)}</div>
                </div>
            `;
            orderItems.appendChild(itemDiv);
        });
    }
    
    function displayCustomerDetails(address, deliveryMode) {
        const customerDetails = document.getElementById('customer-details');
        if (!customerDetails) return;
        
        let detailsHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        `;
        
        if (address.name) {
            detailsHTML += `
                <div class="flex items-start">
                    <span class="text-blue-600 mr-2 text-xl">üë§</span>
                    <div>
                        <div class="text-sm text-blue-500">Name</div>
                        <div class="font-semibold text-gray-800">${address.name}</div>
                    </div>
                </div>
            `;
        }
        
        if (address.phone) {
            detailsHTML += `
                <div class="flex items-start">
                    <span class="text-blue-600 mr-2 text-xl">üì±</span>
                    <div>
                        <div class="text-sm text-blue-500">Phone</div>
                        <div class="font-semibold text-gray-800">${address.phone}</div>
                    </div>
                </div>
            `;
        }
        
        const modeText = deliveryMode === 'delivery' ? 'Home Delivery' : 'Takeaway';
        const modeIcon = deliveryMode === 'delivery' ? 'üõµ' : 'üè™';
        detailsHTML += `
            <div class="flex items-start md:col-span-2">
                <span class="text-blue-600 mr-2 text-xl">${modeIcon}</span>
                <div>
                    <div class="text-sm text-blue-500">Order Type</div>
                    <div class="font-semibold text-gray-800">${modeText}</div>
                </div>
            </div>
        `;
        
        detailsHTML += `
                </div>
            </div>
        `;
        
        customerDetails.innerHTML = detailsHTML;
    }
    
    function displayDeliveryAddress(address, delivery, deliveryMode) {
        const deliveryAddress = document.getElementById('delivery-address');
        if (!deliveryAddress) return;
        
        if (deliveryMode === 'delivery') {
            let addressHTML = `
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <div class="flex items-center mb-3">
                        <span class="text-green-600 mr-2 text-xl">üìç</span>
                        <span class="font-semibold text-gray-800">Delivery Address</span>
                    </div>
            `;
            
            if (address.houseNumber || address.locality) {
                const addressLine1 = `${address.houseNumber || ''}${address.houseNumber && address.locality ? ', ' : ''}${address.locality || ''}`;
                const addressLine2 = address.street ? address.street : '';
                const cityLine = `${address.city || 'Indore'}, ${address.state || 'MP'} - ${address.pincode || ''}`;
                
                if (addressLine1.trim()) {
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Address</div>
                        <div class="font-medium text-gray-800">${addressLine1}</div>
                    </div>`;
                }
                
                if (addressLine2) {
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Street/Landmark</div>
                        <div class="font-medium text-gray-800">${addressLine2}</div>
                    </div>`;
                }
                
                addressHTML += `<div class="mb-2">
                    <div class="text-sm text-gray-600 mb-1">City & Pincode</div>
                    <div class="font-medium text-gray-800">${cityLine}</div>
                </div>`;
                
                if (address.addressType) {
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Address Type</div>
                        <div class="font-medium text-gray-800">${address.addressType}</div>
                    </div>`;
                }
                
                if (delivery.distance) {
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Distance</div>
                        <div class="font-medium text-gray-800">${delivery.distance} km from restaurant</div>
                    </div>`;
                }
                
                if (delivery.location) {
                    const lat = delivery.location.lat;
                    const lng = delivery.location.lng;
                    const mapsLink = `https://www.google.com/maps?q=${lat},${lng}`;
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Map Location</div>
                        <a href="${mapsLink}" target="_blank" class="font-medium text-blue-600 hover:text-blue-800 underline">
                            View on Google Maps ‚Üí
                        </a>
                    </div>`;
                }
            }
            
            addressHTML += `</div>`;
            deliveryAddress.innerHTML = addressHTML;
            
        } else {
            deliveryAddress.innerHTML = `
                <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
                    <div class="flex items-center mb-3">
                        <span class="text-purple-600 mr-2 text-xl">üè™</span>
                        <span class="font-semibold text-gray-800">Pickup Details</span>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Pickup Location</div>
                            <div class="font-medium text-gray-800">Prime Square, Omaxe City 1, Indore</div>
                        </div>
                        
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Pickup Timings</div>
                            <div class="font-medium text-gray-800">5:45 PM - 11:30 PM</div>
                        </div>
                        
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Map Location</div>
                            <a href="https://maps.app.goo.gl/kz2BKTUPpuyHC6Jr8" target="_blank" class="font-medium text-blue-600 hover:text-blue-800 underline">
                                View on Google Maps ‚Üí
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // RAZORPAY PAYMENT
    function initiatePayment() {
        if (paymentProcessing) {
            showNotification('error', 'Payment already in progress');
            return;
        }
        
        if (!orderData.address?.phone) {
            showNotification('error', 'Phone number required');
            return;
        }
        
        if (finalAmount < 1) {
            showNotification('error', 'Invalid payment amount');
            return;
        }
        
        paymentProcessing = true;
        showLoading();
        
        // SIMPLE RAZORPAY OPTIONS
        const options = {
            key: RAZORPAY_KEY_ID,
            amount: Math.round(finalAmount * 100),
            currency: "INR",
            name: "Easy Go",
            description: `Order Payment - ${orderData.address.name}`,
            prefill: {
                name: orderData.address.name || "Customer",
                contact: orderData.address.phone || "",
                email: "customer@easygo.com"
            },
            handler: function(response) {
                handlePaymentSuccess(response.razorpay_payment_id);
            },
            theme: { 
                color: "#10B981"
            },
            modal: {
                ondismiss: function() {
                    paymentProcessing = false;
                    hideLoading();
                    document.getElementById('retry-payment').classList.remove('hidden');
                }
            }
        };
        
        try {
            const rzp = new Razorpay(options);
            
            rzp.on('payment.failed', function(response) {
                paymentProcessing = false;
                hideLoading();
                showAlert('error-alert');
                document.getElementById('error-details').textContent = response.error.description || 'Payment failed';
                document.getElementById('retry-payment').classList.remove('hidden');
            });
            
            rzp.open();
            
        } catch (error) {
            console.error("Razorpay error:", error);
            paymentProcessing = false;
            hideLoading();
            showAlert('error-alert');
            document.getElementById('error-details').textContent = 'Unable to connect to payment gateway';
        }
    }
    
    function handlePaymentSuccess(paymentId) {
        paymentProcessing = false;
        hideLoading();
        
        if (!paymentId) {
            showAlert('error-alert');
            document.getElementById('error-details').textContent = 'No payment ID received';
            return;
        }
        
        processPaymentSuccess(paymentId);
    }
    
    function processPaymentSuccess(paymentId) {
        const otp = Math.floor(100000 + Math.random() * 900000).toString();
        const orderId = "EG" + Date.now().toString().slice(-8);
        
        currentOrder = {
            id: orderId,
            paymentId: paymentId,
            otp: otp,
            amount: finalAmount,
            customer: orderData.address.name,
            phone: orderData.address.phone,
            items: orderData.cart.map(item => ({
                name: item.name,
                quantity: item.quantity,
                pack: item.pack,
                unitPrice: parseFloat(item.unitPrice) || 0,
                total: parseFloat(item.total) || parseFloat(item.totalPrice) || 0
            })),
            deliveryMode: orderData.totals.deliveryMode,
            totals: orderData.totals,
            address: orderData.address,
            delivery: orderData.delivery,
            timestamp: new Date().toISOString(),
            paymentMethod: "razorpay",
            status: "confirmed"
        };
        
        saveOrderAndProceed(currentOrder, otp);
        sendWhatsAppMessage(currentOrder); // SEND WHATSAPP IMMEDIATELY
        document.getElementById('generated-otp').textContent = otp;
        showAlert('success-alert');
        showNotification('success');
    }
    
    // WHATSAPP MESSAGE FUNCTION - NOW WORKING
    function sendWhatsAppMessage(order) {
        // Format message for WhatsApp
        let message = `üì¶ *NEW ORDER RECEIVED* üì¶%0A%0A`;
        
        // Order Details
        message += `*Order ID:* ${order.id}%0A`;
        message += `*OTP:* ${order.otp}%0A`;
        message += `*Amount:* ‚Çπ${order.amount.toFixed(2)}%0A`;
        message += `*Payment ID:* ${order.paymentId}%0A`;
        message += `*Status:* CONFIRMED ‚úÖ%0A%0A`;
        
        // Items Ordered
        message += `*ITEMS ORDERED:*%0A`;
        message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A`;
        order.items.forEach(item => {
            const quantity = parseInt(item.quantity) || 1;
            const unitPrice = parseFloat(item.unitPrice) || 0;
            const totalPrice = parseFloat(item.total) || (unitPrice * quantity);
            
            message += `‚Ä¢ ${item.name} √ó ${quantity}%0A`;
            message += `  Pack: ${item.pack || 'Standard'}%0A`;
            message += `  Price: ‚Çπ${unitPrice.toFixed(2)} √ó ${quantity} = ‚Çπ${totalPrice.toFixed(2)}%0A%0A`;
        });
        
        // Payment Breakdown
        message += `*PAYMENT BREAKDOWN:*%0A`;
        message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A`;
        message += `Food Total: ‚Çπ${order.totals.foodTotal.toFixed(2)}%0A`;
        message += `GST on Food (5%): ‚Çπ${order.totals.gstFood.toFixed(2)}%0A`;
        
        if (order.deliveryMode === 'delivery') {
            message += `Delivery Charge: ‚Çπ${order.totals.deliveryCharge.toFixed(2)}%0A`;
            if (order.totals.deliveryCharge === 9) {
                message += `GST on Delivery: Included in ‚Çπ9%0A`;
            } else {
                message += `GST on Delivery (18%): ‚Çπ${order.totals.gstDelivery.toFixed(2)}%0A`;
            }
        }
        
        message += `*TOTAL: ‚Çπ${order.amount.toFixed(2)}*%0A%0A`;
        
        // Customer Details
        message += `*CUSTOMER DETAILS:*%0A`;
        message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A`;
        message += `üë§ Name: ${order.customer}%0A`;
        message += `üì± Phone: ${order.phone}%0A`;
        message += `üí≥ Payment: Razorpay (Online)%0A%0A`;
        
        // Delivery/Pickup Details
        if (order.deliveryMode === 'delivery') {
            message += `*üìç DELIVERY ADDRESS:*%0A`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A`;
            
            // Build address
            const addressParts = [];
            if (order.address.houseNumber) addressParts.push(order.address.houseNumber);
            if (order.address.floorNumber) addressParts.push(`Floor ${order.address.floorNumber}`);
            if (order.address.street) addressParts.push(order.address.street);
            if (order.address.locality) addressParts.push(order.address.locality);
            if (order.address.city) addressParts.push(order.address.city);
            if (order.address.state) addressParts.push(order.address.state);
            if (order.address.pincode) addressParts.push(order.address.pincode);
            
            message += addressParts.join(', ') + '%0A';
            
            if (order.delivery?.distance) {
                message += `Distance: ${order.delivery.distance} km%0A`;
            }
            
            if (order.delivery?.location) {
                const lat = order.delivery.location.lat;
                const lng = order.delivery.location.lng;
                message += `üìç Maps: https://maps.google.com/?q=${lat},${lng}%0A`;
            }
            
            if (order.address.addressType) {
                message += `Address Type: ${order.address.addressType}%0A`;
            }
        } else {
            message += `*üè™ PICKUP DETAILS:*%0A`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A`;
            message += `Prime Square, Omaxe City 1, Indore%0A`;
            message += `üìç Maps: https://maps.app.goo.gl/kz2BKTUPpuyHC6Jr8%0A`;
            message += `Timings: 5:45 PM - 11:30 PM%0A`;
            message += `Customer: ${order.customer}%0A`;
            message += `Phone: ${order.phone}%0A`;
            message += `üìã OTP verification required at pickup%0A`;
        }
        
        // Order Time
        message += `%0A*üìÖ ORDER TIME:*%0A`;
        message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A`;
        message += `‚è∞ ${new Date().toLocaleTimeString()}%0A`;
        message += `üìÖ ${new Date().toLocaleDateString()}%0A%0A`;
        
        message += `_Order placed via EasyGo Payment System_`;
        
        // Create WhatsApp URL
        const whatsappURL = `https://wa.me/${RESTAURANT_PHONE}?text=${encodeURIComponent(message)}`;
        
        // Open WhatsApp in new tab
        console.log("Opening WhatsApp URL:", whatsappURL);
        
        // Try different methods to ensure WhatsApp opens
        setTimeout(() => {
            // Method 1: Direct window.open
            window.open(whatsappURL, '_blank');
            
            // Method 2: Create and click link
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = whatsappURL;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.click();
            }, 100);
            
            // Method 3: Location change (fallback)
            setTimeout(() => {
                if (navigator.userAgent.match(/Android|iPhone|iPad|iPod/i)) {
                    window.location.href = whatsappURL;
                }
            }, 200);
        }, 500);
        
        return true;
    }
    
    function viewWhatsAppMessage() {
        if (currentOrder) {
            sendWhatsAppMessage(currentOrder);
        }
    }
    
    // SAVE ORDER
    function saveOrderAndProceed(order, otp) {
        try {
            // Save to all storages
            localStorage.setItem('easygo-otp', otp);
            localStorage.setItem('easygo-order-id', order.id);
            localStorage.setItem('easygo-last-order', JSON.stringify(order));
            localStorage.setItem('easygo-last-payment-id', order.paymentId);
            
            // Save to active orders
            let activeOrders = JSON.parse(localStorage.getItem('easygo-active-orders') || '[]');
            activeOrders.push({
                orderId: order.id,
                razorpayPaymentId: order.paymentId,
                customerName: order.customer,
                customerPhone: order.phone,
                totalAmount: order.amount,
                items: order.items,
                address: order.deliveryMode === 'delivery' ? 
                    `${order.address?.houseNumber || ''}, ${order.address?.locality || ''}, ${order.address?.city || 'Indore'}` : 
                    "Takeaway - Prime Square",
                deliveryMode: order.deliveryMode,
                status: 'confirmed',
                timestamp: order.timestamp,
                otp: otp,
                completeAddress: order.address,
                deliveryDetails: order.delivery
            });
            localStorage.setItem('easygo-active-orders', JSON.stringify(activeOrders));
            
            // Save to delivery orders for rider app
            let deliveryOrders = JSON.parse(localStorage.getItem('easygo-delivery-orders') || '[]');
            deliveryOrders.push({
                orderId: order.id,
                customerName: order.customer,
                customerPhone: order.phone,
                amount: order.amount,
                otp: otp,
                address: order.deliveryMode === 'delivery' ? 
                    `${order.address?.houseNumber || ''}, ${order.address?.locality || ''}, ${order.address?.city || 'Indore'}` : 
                    "Takeaway",
                deliveryMode: order.deliveryMode,
                status: 'pending',
                timestamp: order.timestamp
            });
            localStorage.setItem('easygo-delivery-orders', JSON.stringify(deliveryOrders));
            
            // Clear cart
            localStorage.removeItem('easygo-cart');
            localStorage.removeItem('easygo-cart-items-total');
            
        } catch (error) {
            console.error("Error saving order:", error);
        }
    }
    
    function goToTracking() {
        window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
    }
    
    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', function() {
        if (!loadOrderData()) {
            return;
        }
        
        // Setup event listeners
        document.getElementById('razorpay-pay-btn').addEventListener('click', initiatePayment);
    });
</script>
    
</body>
</html>
