<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <title>Easy Go | Secure Payment</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .payment-success {
            animation: successPulse 2s infinite;
        }
        
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .razorpay-payment-button { display: none !important; }
        
        .error-banner {
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .pulse-dot {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .qr-code-container {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

    <!-- Global Error Banner -->
    <div id="global-error-banner" class="error-banner fixed top-0 left-0 right-0 bg-red-500 text-white py-3 px-4 text-center font-medium z-50 hidden">
        <div class="flex items-center justify-center">
            <span class="text-xl mr-2">‚ö†Ô∏è</span>
            <span id="global-error-text"></span>
            <button onclick="hideGlobalError()" class="ml-4 text-white hover:text-gray-200">‚úï</button>
        </div>
    </div>

    <!-- Payment Status Indicator -->
    <div id="payment-status-indicator" class="fixed top-4 left-4 bg-white rounded-xl shadow-lg p-4 z-40 hidden fade-in">
        <div class="flex items-center space-x-3">
            <div class="pulse-dot w-3 h-3 bg-yellow-500 rounded-full"></div>
            <span class="font-medium">Processing payment...</span>
        </div>
    </div>

    <header class="relative mb-8">
        <div class="h-40 overflow-hidden gradient-bg">
            <div class="absolute inset-0 flex items-center justify-center">
                <h1 class="text-3xl md:text-4xl font-bold text-white text-center px-4">Secure Payment Gateway</h1>
            </div>
        </div>
        <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                 class="h-20 w-20 rounded-full border-4 border-white shadow-2xl bg-white p-1 transform transition-transform hover:scale-105">
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 pt-10 pb-20">
        <!-- Alternative Payment Methods Modal -->
        <div id="alternative-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-3xl p-8 max-w-md mx-4 w-full">
                <div class="text-center">
                    <div class="text-5xl mb-4">üîß</div>
                    <h3 class="text-2xl font-bold mb-4">Alternative Payment Methods</h3>
                    <p class="text-gray-600 mb-6">We noticed some issues with automatic payment. Please choose an option:</p>
                    
                    <div class="space-y-4 mb-6">
                        <button id="manual-upi-pay" 
                                class="w-full py-4 bg-green-500 text-white font-bold rounded-2xl hover:bg-green-600 transition-colors shadow-lg hover:shadow-xl flex items-center justify-center">
                            <span class="mr-3">üì±</span>
                            Pay via UPI ID
                        </button>
                        
                        <button id="manual-qr-pay" 
                                class="w-full py-4 bg-blue-500 text-white font-bold rounded-2xl hover:bg-blue-600 transition-colors shadow-lg hover:shadow-xl flex items-center justify-center">
                            <span class="mr-3">üì∑</span>
                            Scan QR Code
                        </button>
                        
                        <button id="manual-bank-transfer" 
                                class="w-full py-4 bg-purple-500 text-white font-bold rounded-2xl hover:bg-purple-600 transition-colors shadow-lg hover:shadow-xl flex items-center justify-center">
                            <span class="mr-3">üè¶</span>
                            Bank Transfer
                        </button>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t">
                        <button onclick="document.getElementById('alternative-payment-modal').classList.add('hidden')" 
                                class="text-gray-600 hover:text-gray-800">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Recovery Modal -->
        <div id="payment-recovery-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-3xl p-8 max-w-md mx-4 w-full">
                <div class="text-center">
                    <div class="text-5xl mb-4">üîÑ</div>
                    <h3 class="text-2xl font-bold mb-4">Payment Status Unclear</h3>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-4 mb-6">
                        <p class="text-yellow-800 mb-3">
                            <strong>Don't worry!</strong> We've detected a payment attempt but need to confirm its status.
                        </p>
                        <p class="text-sm text-yellow-700">
                            Please check your bank statement or UPI app. If deducted, your order is confirmed.
                        </p>
                    </div>
                    
                    <div class="space-y-4">
                        <button id="check-status-btn" 
                                class="w-full py-4 bg-green-500 text-white font-bold rounded-2xl hover:bg-green-600 transition-colors shadow-lg">
                            Check Payment Status
                        </button>
                        
                        <button id="retry-payment-btn" 
                                class="w-full py-4 bg-blue-500 text-white font-bold rounded-2xl hover:bg-blue-600 transition-colors shadow-lg">
                            Try Payment Again
                        </button>
                        
                        <button id="contact-support-btn" 
                                class="w-full py-4 bg-gray-200 text-gray-800 font-bold rounded-2xl hover:bg-gray-300 transition-colors">
                            Contact Support
                        </button>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t">
                        <p class="text-sm text-gray-600">
                            <strong>Note:</strong> If amount was deducted but order not confirmed, it will be automatically refunded in 24-48 hours.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual UPI Payment Modal -->
        <div id="manual-upi-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-3xl p-8 max-w-md mx-4 w-full">
                <div class="text-center">
                    <h3 class="text-2xl font-bold mb-6">Manual UPI Payment</h3>
                    
                    <div class="bg-gray-50 rounded-2xl p-6 mb-6">
                        <div class="text-sm text-gray-600 mb-2">UPI ID:</div>
                        <div class="text-2xl font-bold text-green-600 mb-2" id="upi-id-display">easygo.food@axisbank</div>
                        <button onclick="copyUPI()" class="text-blue-600 hover:text-blue-800 text-sm">
                            üìã Copy UPI ID
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <div class="text-sm text-gray-600 mb-2">Amount to Pay:</div>
                        <div class="text-3xl font-bold" id="manual-amount">‚Çπ0</div>
                    </div>
                    
                    <div class="text-left bg-blue-50 p-4 rounded-xl mb-6">
                        <h4 class="font-bold mb-2">Instructions:</h4>
                        <ol class="list-decimal pl-5 space-y-1 text-sm">
                            <li>Open your UPI app (GPay, PhonePe, Paytm, etc.)</li>
                            <li>Paste the UPI ID above</li>
                            <li>Enter the exact amount shown</li>
                            <li>Add your Order ID in description: <span id="manual-order-id" class="font-bold">EG123456</span></li>
                            <li>Complete the payment</li>
                        </ol>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="document.getElementById('manual-upi-modal').classList.add('hidden')" 
                                class="flex-1 py-3 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300">
                            Cancel
                        </button>
                        <button id="confirm-manual-payment" 
                                class="flex-1 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600">
                            I've Paid
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Payment Modal -->
        <div id="qr-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-3xl p-8 max-w-md mx-4 w-full">
                <div class="text-center">
                    <h3 class="text-2xl font-bold mb-6">Scan QR Code to Pay</h3>
                    
                    <div class="qr-code-container rounded-2xl p-6 mb-6 flex flex-col items-center">
                        <div class="text-sm text-gray-600 mb-2">Scan with any UPI app</div>
                        <div id="qr-code-placeholder" class="w-64 h-64 bg-gray-200 rounded-lg mb-4 flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-4xl mb-2">üì±</div>
                                <div class="text-sm text-gray-600">QR Code Loading...</div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">Amount: <span id="qr-amount" class="font-bold">‚Çπ0</span></div>
                    </div>
                    
                    <div class="text-left bg-green-50 p-4 rounded-xl mb-6">
                        <h4 class="font-bold mb-2">How to pay:</h4>
                        <ul class="list-disc pl-5 space-y-1 text-sm">
                            <li>Open any UPI app on your phone</li>
                            <li>Tap on "Scan QR Code"</li>
                            <li>Scan the QR code above</li>
                            <li>Verify amount and complete payment</li>
                        </ul>
                    </div>
                    
                    <button onclick="document.getElementById('qr-payment-modal').classList.add('hidden')" 
                            class="w-full py-3 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Order Summary -->
            <div class="space-y-8">
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="mr-3">üì¶</span>
                        Order Summary
                    </h2>
                    
                    <div id="order-items" class="space-y-4 mb-6 max-h-80 overflow-y-auto pr-2">
                        <!-- Items loaded from localStorage -->
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="font-bold mb-4 flex items-center">
                            <span class="mr-2">üë§</span>
                            Customer Details
                        </h3>
                        <div id="customer-details" class="space-y-2">
                            <!-- Details loaded from localStorage -->
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <h3 class="font-bold mb-4 flex items-center">
                        <span class="mr-2">üìç</span>
                        Order Details
                    </h3>
                    <div id="delivery-address" class="space-y-2">
                        <!-- Address loaded from localStorage -->
                    </div>
                    
                    <div class="mt-6 pt-6 border-t">
                        <div class="flex items-center text-sm text-gray-600">
                            <span class="mr-2">üîê</span>
                            <span>Your payment is secured with 256-bit SSL encryption</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div class="space-y-8">
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="mr-3">üí∞</span>
                        Payment Summary
                    </h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between py-2">
                            <span class="text-gray-700">Food Items Total</span>
                            <span id="food-total" class="font-semibold">‚Çπ0</span>
                        </div>
                        
                        <div id="coupon-row" class="flex justify-between text-green-600 py-2 hidden">
                            <span>Coupon Discount</span>
                            <span id="coupon-discount" class="font-semibold">-‚Çπ0</span>
                        </div>
                        
                        <div class="flex justify-between py-2">
                            <span class="text-gray-700">GST on Food (5%)</span>
                            <span id="gst-food" class="font-semibold">‚Çπ0</span>
                        </div>
                        
                        <div id="delivery-row" class="border-t pt-4 mt-2 hidden">
                            <div class="flex justify-between py-2">
                                <span class="text-gray-700">Delivery Charge</span>
                                <span id="delivery-charge" class="font-semibold">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-700">GST on Delivery (18%)</span>
                                <span id="gst-delivery" class="font-semibold">‚Çπ0</span>
                            </div>
                        </div>
                        
                        <div class="border-t-2 border-gray-300 pt-4 mt-2">
                            <div class="flex justify-between text-xl font-bold py-2">
                                <span class="text-gray-800">Total Amount Payable</span>
                                <span id="final-total" class="text-green-600">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t">
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <div class="flex items-center">
                                <span class="mr-2">üí≥</span>
                                <span>Multiple payment options available</span>
                            </div>
                            <span class="text-green-600 font-medium">No hidden charges</span>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Options -->
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <div class="text-center mb-8">
                        <div class="inline-block bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 text-green-800 px-8 py-4 rounded-2xl mb-4">
                            <div class="text-sm font-medium mb-1">Total to pay</div>
                            <span class="font-bold text-3xl" id="payment-amount">‚Çπ0</span>
                        </div>
                        <p class="text-gray-600">Choose your preferred payment method</p>
                    </div>
                    
                    <div class="space-y-4 mb-8">
                        <!-- Primary Razorpay Button -->
                        <button id="razorpay-pay-btn" 
                                class="w-full py-5 bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-xl font-bold rounded-2xl hover:from-blue-700 hover:to-indigo-800 transition-all duration-300 transform hover:-translate-y-0.5 shadow-xl hover:shadow-2xl flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none">
                            <svg class="w-7 h-7 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.436 7.406H1.564a1.25 1.25 0 0 0-1.108 1.831l1.414 2.823a1.25 1.25 0 0 0 1.108.669h19.242a1.25 1.25 0 0 0 1.108-.669l1.414-2.823a1.25 1.25 0 0 0-1.108-1.831z"/>
                                <path d="M2.5 12.406h19v9h-19z"/>
                            </svg>
                            Pay Now - ‚Çπ<span id="pay-amount">0</span>
                        </button>
                        
                        <!-- QR Code Payment Button -->
                        <button id="qr-pay-btn" 
                                class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-2xl hover:from-green-600 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
                            <span class="mr-3 text-2xl">üì∑</span>
                            Pay via QR Code
                        </button>
                        
                        <!-- Alternative Payment Methods -->
                        <div class="pt-4 border-t">
                            <button id="show-alternative-methods" 
                                    class="w-full py-3 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">üîÑ</span>
                                Other Payment Methods
                            </button>
                        </div>
                        
                        <div class="text-center pt-4">
                            <div class="inline-flex items-center justify-center space-x-3 text-sm text-gray-600 bg-gray-50 px-6 py-3 rounded-full">
                                <span class="flex items-center">
                                    <span class="text-green-500 mr-1">‚úì</span>
                                    Secure
                                </span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>Cards</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>UPI</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>NetBanking</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Powered by Razorpay ‚Ä¢ PCI DSS Certified</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 pt-6 border-t">
                        <div class="flex justify-between items-center">
                            <a href="https://clean-scripts.github.io/Easygo-Address/" 
                               class="text-gray-600 hover:text-gray-900 flex items-center group transition-colors">
                                <span class="text-xl mr-2 group-hover:-translate-x-1 transition-transform">‚Üê</span>
                                <span>Back to Address</span>
                            </a>
                            <button id="retry-payment" 
                                    class="text-blue-600 hover:text-blue-800 hidden flex items-center group">
                                <span class="mr-2 group-hover:rotate-180 transition-transform">üîÑ</span>
                                <span>Retry Payment</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Assurance Card -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-3xl p-6">
                    <div class="flex items-start">
                        <div class="text-3xl mr-4">üõ°Ô∏è</div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">Payment Assurance</h3>
                            <p class="text-sm text-gray-700 mb-3">
                                If you face any payment issues, we guarantee:
                            </p>
                            <ul class="space-y-2 text-sm">
                                <li class="flex items-center">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    <span>Automatic refunds within 24-48 hours if payment fails</span>
                                </li>
                                <li class="flex items-center">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    <span>Multiple fallback payment methods available</span>
                                </li>
                                <li class="flex items-center">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    <span>24/7 support for payment-related queries</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="text-6xl mb-6">üéâ</div>
                <h3 class="text-2xl font-bold mb-4">Payment Successful!</h3>
                <p class="text-gray-600 mb-6">Your order has been confirmed. Please save this OTP:</p>
                
                <div class="text-4xl font-bold text-green-600 mb-6 bg-gray-100 p-4 rounded-2xl payment-success" id="generated-otp">
                    123456
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-2xl p-4 mb-6">
                    <p class="text-sm text-green-800">
                        <strong>Next steps:</strong> Share this OTP with delivery partner for verification.
                    </p>
                </div>
                
                <p class="text-sm text-gray-500 mb-6">
                    Redirecting to tracking page...
                </p>
                
                <button id="go-to-tracking" 
                        class="w-full py-4 bg-green-500 text-white font-bold rounded-2xl hover:bg-green-600 transition-colors shadow-lg hover:shadow-xl">
                    Track Your Order Now ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="loader mx-auto mb-6"></div>
                <h3 class="text-2xl font-bold mb-4">Processing Payment</h3>
                <p class="text-gray-600 mb-6" id="loading-message">Connecting to payment gateway...</p>
                <div class="space-y-2">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-green-500 h-2 rounded-full" style="width: 30%"></div>
                    </div>
                    <p class="text-sm text-gray-500">Do not close this window</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Failed Modal -->
    <div id="payment-failed-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="text-6xl mb-6">‚ùå</div>
                <h3 class="text-2xl font-bold mb-4">Payment Failed</h3>
                
                <div class="bg-red-50 border border-red-200 rounded-2xl p-4 mb-6">
                    <p class="text-red-800 mb-3" id="failure-reason">We couldn't process your payment</p>
                    <p class="text-sm text-red-700">
                        <strong>Don't worry!</strong> If amount was deducted, it will be automatically refunded in 24-48 working hours as per your bank's policy.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <button id="retry-after-failure" 
                            class="w-full py-4 bg-blue-500 text-white font-bold rounded-2xl hover:bg-blue-600 transition-colors shadow-lg">
                        Try Payment Again
                    </button>
                    
                    <button id="try-alternative-methods" 
                            class="w-full py-4 bg-green-500 text-white font-bold rounded-2xl hover:bg-green-600 transition-colors shadow-lg">
                        Try Other Payment Methods
                    </button>
                    
                    <button onclick="document.getElementById('payment-failed-modal').classList.add('hidden')" 
                            class="w-full py-3 bg-gray-200 text-gray-800 rounded-2xl hover:bg-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Secure Payments ‚Ä¢ Fast Delivery</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <div class="flex items-center justify-center md:justify-end space-x-4 mb-4">
                        <div class="flex items-center text-sm">
                            <span class="text-green-400 mr-1">‚úì</span>
                            <span>100% Secure</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <span class="text-green-400 mr-1">‚úì</span>
                            <span>PCI DSS Compliant</span>
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go | All Rights Reserved
                    </p>
                    <div class="mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<script>
    // CONFIGURATION
    const RAZORPAY_KEY_ID = "rzp_live_RySoaT17nxFQSV";
    const UPI_ID = "easygo.food@axisbank";
    const SUPPORT_PHONE = "+917651837322";
    const SUPPORT_WHATSAPP = "https://wa.me/917651837322";
    
    // GLOBAL STATE
    let orderData = {};
    let finalAmount = 0;
    let paymentProcessing = false;
    let paymentAttempts = 0;
    const MAX_PAYMENT_ATTEMPTS = 3;
    let currentPaymentId = null;
    let fallbackPaymentActive = false;
    
    // ERROR HANDLING ENHANCEMENTS
    const errorMessages = {
        network: "Network error. Please check your internet connection.",
        amount: "Invalid payment amount. Please refresh and try again.",
        customer: "Customer details incomplete. Please go back and fill details.",
        razorpay: "Payment gateway error. Trying alternative methods...",
        upi: "UPI apps not detected. Please use alternative payment method.",
        timeout: "Payment timeout. Please try again.",
        generic: "Something went wrong. Don't worry, your money is safe.",
        refund: "If amount was deducted, refund will be processed in 24-48 working hours."
    };
    
    // ENHANCED ERROR HANDLING
    function showGlobalError(message, type = 'error') {
        const banner = document.getElementById('global-error-banner');
        const text = document.getElementById('global-error-text');
        
        // Set appropriate background color
        if (type === 'warning') {
            banner.classList.remove('bg-red-500');
            banner.classList.add('bg-yellow-500');
        } else if (type === 'info') {
            banner.classList.remove('bg-red-500');
            banner.classList.add('bg-blue-500');
        } else {
            banner.classList.remove('bg-yellow-500', 'bg-blue-500');
            banner.classList.add('bg-red-500');
        }
        
        text.textContent = message;
        banner.classList.remove('hidden');
        
        // Auto-hide after 10 seconds for non-critical errors
        if (type !== 'error') {
            setTimeout(hideGlobalError, 10000);
        }
    }
    
    function hideGlobalError() {
        document.getElementById('global-error-banner').classList.add('hidden');
    }
    
    function showPaymentStatus(message) {
        const indicator = document.getElementById('payment-status-indicator');
        indicator.querySelector('span').textContent = message;
        indicator.classList.remove('hidden');
    }
    
    function hidePaymentStatus() {
        document.getElementById('payment-status-indicator').classList.add('hidden');
    }
    
    function showLoading(message = "Connecting to payment gateway...") {
        document.getElementById('loading-message').textContent = message;
        document.getElementById('loading-modal').classList.remove('hidden');
        document.getElementById('razorpay-pay-btn').disabled = true;
        
        // Animate progress bar
        let progress = 30;
        const progressBar = document.getElementById('progress-bar');
        const interval = setInterval(() => {
            progress += 5;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 1000);
        
        // Store interval for cleanup
        window.loadingInterval = interval;
    }
    
    function hideLoading() {
        document.getElementById('loading-modal').classList.add('hidden');
        document.getElementById('razorpay-pay-btn').disabled = false;
        
        // Clear progress animation
        if (window.loadingInterval) {
            clearInterval(window.loadingInterval);
        }
        document.getElementById('progress-bar').style.width = '30%';
    }
    
    // PAYMENT RECOVERY FUNCTIONS
    function showPaymentRecoveryModal() {
        document.getElementById('payment-recovery-modal').classList.remove('hidden');
    }
    
    function showAlternativePaymentMethods() {
        document.getElementById('alternative-payment-modal').classList.remove('hidden');
    }
    
    // LOAD ORDER DATA WITH ENHANCED ERROR HANDLING
    function loadOrderData() {
        try {
            // Load all data with validation
            const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
            const address = JSON.parse(localStorage.getItem('easygo-address') || '{}');
            const delivery = JSON.parse(localStorage.getItem('easygo-delivery') || '{}');
            
            // Validate cart
            if (cart.length === 0) {
                showGlobalError("Your cart is empty. Redirecting to menu...", 'warning');
                setTimeout(() => {
                    window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
                }, 2000);
                return false;
            }
            
            // Validate customer details for delivery
            const deliveryMode = address.deliveryMode || delivery.mode || 'takeaway';
            if (deliveryMode === 'delivery' && (!address.phone || !address.name)) {
                showGlobalError("Please complete delivery details before payment", 'warning');
                setTimeout(() => {
                    window.location.href = 'https://clean-scripts.github.io/Easygo-Address/';
                }, 3000);
                return false;
            }
            
            // Calculate totals with proper error handling
            let foodTotal = 0;
            try {
                foodTotal = parseFloat(localStorage.getItem('easygo-cart-items-total')) || 0;
                if (foodTotal <= 0) {
                    cart.forEach(item => {
                        foodTotal += parseFloat(item.total) || 0;
                    });
                }
            } catch (e) {
                foodTotal = cart.reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0);
            }
            
            // Validate amount
            if (foodTotal <= 0 || foodTotal > 100000) {
                showGlobalError("Invalid order amount. Please refresh and try again.", 'error');
                return false;
            }
            
            // Apply taxes
            const gstFood = Math.round((foodTotal * 0.05) * 100) / 100;
            let deliveryCharge = 0;
            let gstDelivery = 0;
            
            if (deliveryMode === 'delivery') {
                deliveryCharge = parseFloat(delivery.charge) || 49;
                gstDelivery = Math.round((deliveryCharge * 0.18) * 100) / 100;
            }
            
            finalAmount = parseFloat((foodTotal + gstFood + deliveryCharge + gstDelivery).toFixed(2));
            
            // Validate final amount
            if (finalAmount < 1 || finalAmount > 100000) {
                showGlobalError("Invalid total amount. Please contact support.", 'error');
                return false;
            }
            
            // Display all data
            displayCartItems(cart);
            displayCustomerDetails(address);
            displayDeliveryAddress(address, delivery);
            
            // Update payment UI
            updatePaymentUI(foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode);
            
            // Store order data
            orderData = { 
                cart, 
                address, 
                delivery, 
                amount: finalAmount,
                totals: {
                    foodTotal,
                    gstFood,
                    deliveryCharge,
                    gstDelivery,
                    deliveryMode
                }
            };
            
            console.log("Order data loaded successfully:", orderData);
            return true;
            
        } catch (error) {
            console.error("Critical error loading order data:", error);
            showGlobalError("Failed to load order. Please refresh the page.", 'error');
            return false;
        }
    }
    
    function updatePaymentUI(foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode) {
        document.getElementById('food-total').textContent = `‚Çπ${foodTotal.toFixed(2)}`;
        document.getElementById('gst-food').textContent = `‚Çπ${gstFood.toFixed(2)}`;
        
        if (deliveryMode === 'delivery') {
            document.getElementById('delivery-row').classList.remove('hidden');
            document.getElementById('delivery-charge').textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
            document.getElementById('gst-delivery').textContent = `‚Çπ${gstDelivery.toFixed(2)}`;
        }
        
        document.getElementById('final-total').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
        document.getElementById('payment-amount').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
        document.getElementById('pay-amount').textContent = finalAmount.toFixed(2);
        
        // Update manual payment amounts
        document.getElementById('manual-amount').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
        document.getElementById('qr-amount').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
    }
    
    // DISPLAY FUNCTIONS (keep your existing displayCartItems, displayCustomerDetails, displayDeliveryAddress)
    // ... [Your existing display functions remain the same] ...
    
    // ENHANCED RAZORPAY PAYMENT WITH QR SUPPORT
    function initiateRazorpayPayment() {
        if (paymentProcessing) {
            showGlobalError("A payment is already in progress", 'warning');
            return;
        }
        
        if (!validatePaymentPrerequisites()) {
            return;
        }
        
        paymentAttempts++;
        showLoading("Initializing secure payment...");
        paymentProcessing = true;
        showPaymentStatus("Opening payment gateway...");
        
        const options = {
            key: RAZORPAY_KEY_ID,
            amount: Math.round(finalAmount * 100),
            currency: "INR",
            name: "Easy Go",
            description: `Order Payment - ${orderData.address.name || 'Customer'}`,
            prefill: {
                name: orderData.address.name || "Customer",
                contact: orderData.address.phone || "",
                email: orderData.address.email || "customer@easygo.com"
            },
            handler: function(response) {
                console.log("Payment success response:", response);
                hideLoading();
                hidePaymentStatus();
                paymentProcessing = false;
                processPaymentSuccess(response.razorpay_payment_id);
            },
            theme: { 
                color: "#10B981",
                hide_topbar: false
            },
            modal: {
                ondismiss: function() {
                    handlePaymentDismiss();
                },
                animation: true,
                backdropclose: false
            },
            retry: {
                enabled: true,
                max_count: 2
            },
            timeout: 300,
            remember_customer: true,
            notes: {
                order_type: orderData.totals.deliveryMode,
                items_count: orderData.cart.length.toString()
            }
        };
        
        // Add QR code option for UPI
        if (window.Razorpay && window.Razorpay.setUpiQr) {
            options.method = {
                upi: {
                    flow: "collect",
                    vpa: UPI_ID
                },
                netbanking: true,
                card: true,
                wallet: true
            };
            
            // Set QR code for UPI
            try {
                const rzp = new Razorpay(options);
                rzp.setUpiQr({
                    upi: {
                        vpa: UPI_ID
                    }
                });
            } catch (e) {
                console.log("QR code setup failed, continuing without it:", e);
            }
        }
        
        try {
            const rzp = new Razorpay(options);
            currentPaymentId = rzp._id;
            
            // Enhanced error handling
            rzp.on('payment.failed', function(response) {
                console.error("Payment failed:", response);
                hideLoading();
                hidePaymentStatus();
                paymentProcessing = false;
                
                let errorMsg = response.error.description || "Payment failed";
                
                // Check for UPI app not installed error
                if (errorMsg.includes('UPI') || errorMsg.includes('app')) {
                    errorMsg = "UPI apps not detected. Please try alternative payment method.";
                    setTimeout(() => showAlternativePaymentMethods(), 1000);
                }
                
                showPaymentFailure(errorMsg, response);
            });
            
            rzp.on('payment.authorized', function(response) {
                console.log("Payment authorized:", response);
            });
            
            rzp.open();
            
            // Auto timeout handling
            setTimeout(() => {
                if (paymentProcessing) {
                    hideLoading();
                    hidePaymentStatus();
                    paymentProcessing = false;
                    
                    if (paymentAttempts < MAX_PAYMENT_ATTEMPTS) {
                        showGlobalError("Payment timeout. Trying alternative method...", 'warning');
                        setTimeout(() => showAlternativePaymentMethods(), 1500);
                    } else {
                        showPaymentFailure("Payment timed out. Please try alternative methods.");
                    }
                }
            }, 120000); // 2 minutes timeout
            
        } catch (error) {
            console.error("Razorpay initialization error:", error);
            hideLoading();
            hidePaymentStatus();
            paymentProcessing = false;
            
            if (paymentAttempts < MAX_PAYMENT_ATTEMPTS) {
                showGlobalError("Payment gateway error. Trying alternative...", 'warning');
                setTimeout(() => showAlternativePaymentMethods(), 1000);
            } else {
                showPaymentFailure("Unable to initialize payment gateway.");
            }
        }
    }
    
    function validatePaymentPrerequisites() {
        if (!orderData.address?.phone) {
            showGlobalError("Please add your phone number for payment", 'warning');
            return false;
        }
        
        if (finalAmount < 1) {
            showGlobalError("Invalid payment amount. Please refresh page.", 'error');
            return false;
        }
        
        if (paymentAttempts >= MAX_PAYMENT_ATTEMPTS) {
            showGlobalError("Maximum payment attempts reached. Please try alternative methods.", 'warning');
            showAlternativePaymentMethods();
            return false;
        }
        
        return true;
    }
    
    function handlePaymentDismiss() {
        hideLoading();
        hidePaymentStatus();
        paymentProcessing = false;
        
        // Check if payment might have been completed
        checkPotentialPaymentCompletion();
    }
    
    function checkPotentialPaymentCompletion() {
        // Check localStorage for any recent payment attempts
        const lastPaymentAttempt = localStorage.getItem('easygo-last-payment-attempt');
        const now = Date.now();
        
        if (lastPaymentAttempt && (now - parseInt(lastPaymentAttempt)) < 30000) {
            // Recent payment attempt, show recovery modal
            setTimeout(() => showPaymentRecoveryModal(), 1000);
        }
        
        // Store current attempt
        localStorage.setItem('easygo-last-payment-attempt', now.toString());
    }
    
    function showPaymentFailure(error, response = null) {
        const modal = document.getElementById('payment-failed-modal');
        const reason = document.getElementById('failure-reason');
        
        reason.textContent = error;
        modal.classList.remove('hidden');
        
        // Store failure for analytics
        const failureData = {
            error: error,
            response: response,
            timestamp: new Date().toISOString(),
            amount: finalAmount,
            attempts: paymentAttempts
        };
        
        let failures = JSON.parse(localStorage.getItem('easygo-payment-failures') || '[]');
        failures.push(failureData);
        localStorage.setItem('easygo-payment-failures', JSON.stringify(failures));
    }
    
    // ALTERNATIVE PAYMENT METHODS
    function setupAlternativePayments() {
        // Manual UPI Payment
        document.getElementById('manual-upi-pay').addEventListener('click', function() {
            document.getElementById('alternative-payment-modal').classList.add('hidden');
            document.getElementById('manual-upi-modal').classList.remove('hidden');
            document.getElementById('manual-order-id').textContent = "EG" + Date.now().toString().slice(-6);
            document.getElementById('upi-id-display').textContent = UPI_ID;
        });
        
        // QR Code Payment
        document.getElementById('manual-qr-pay').addEventListener('click', function() {
            document.getElementById('alternative-payment-modal').classList.add('hidden');
            showQRCodePayment();
        });
        
        // Bank Transfer
        document.getElementById('manual-bank-transfer').addEventListener('click', function() {
            document.getElementById('alternative-payment-modal').classList.add('hidden');
            showBankTransferDetails();
        });
        
        // Confirm Manual Payment
        document.getElementById('confirm-manual-payment').addEventListener('click', function() {
            const orderId = "EG" + Date.now().toString().slice(-6);
            processManualPayment(orderId);
        });
    }
    
    function showQRCodePayment() {
        const modal = document.getElementById('qr-payment-modal');
        modal.classList.remove('hidden');
        
        // Generate a simple QR code (in production, use a proper QR library)
        const qrPlaceholder = document.getElementById('qr-code-placeholder');
        qrPlaceholder.innerHTML = `
            <div class="text-center">
                <div class="text-6xl mb-4">üì±</div>
                <div class="text-sm text-gray-600 mb-2">UPI QR Code</div>
                <div class="text-xs text-gray-500">Amount: ‚Çπ${finalAmount.toFixed(2)}</div>
                <div class="mt-4">
                    <button onclick="copyUPI()" class="text-blue-600 hover:text-blue-800 text-sm">
                        üìã Copy UPI ID Instead
                    </button>
                </div>
            </div>
        `;
        
        // In production, generate actual QR code using a library like qrcode.js
        // QRCode.toCanvas(document.getElementById('qr-code-placeholder'), 
        //     `upi://pay?pa=${UPI_ID}&am=${finalAmount}&cu=INR&tn=EasyGo Order`, 
        //     { width: 256 });
    }
    
    function copyUPI() {
        const upiId = UPI_ID;
        navigator.clipboard.writeText(upiId).then(() => {
            showGlobalError("UPI ID copied to clipboard!", 'info');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = upiId;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showGlobalError("UPI ID copied!", 'info');
        });
    }
    
    function showBankTransferDetails() {
        alert(`Bank Transfer Details:\n\nBank: Axis Bank\nAccount: Easy Go Foods\nAccount No: 921020012345678\nIFSC: UTIB0000123\nAmount: ‚Çπ${finalAmount.toFixed(2)}\n\nPlease add Order ID: EG${Date.now().toString().slice(-6)} in transaction remarks.`);
    }
    
    function processManualPayment(orderId) {
        document.getElementById('manual-upi-modal').classList.add('hidden');
        showLoading("Verifying manual payment...");
        
        // Simulate payment verification (in production, this would be a server call)
        setTimeout(() => {
            hideLoading();
            
            // Generate OTP
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Save order
            const order = {
                id: orderId,
                paymentId: "MANUAL_" + Date.now(),
                otp: otp,
                amount: finalAmount,
                customer: orderData.address.name,
                phone: orderData.address.phone,
                items: orderData.cart,
                deliveryMode: orderData.totals.deliveryMode,
                totals: orderData.totals,
                timestamp: new Date().toISOString(),
                paymentMethod: "manual_upi"
            };
            
            saveOrderAndProceed(order, otp);
            
        }, 3000);
    }
    
    // PAYMENT SUCCESS PROCESSING
    function processPaymentSuccess(paymentId) {
        // Generate OTP
        const otp = Math.floor(100000 + Math.random() * 900000).toString();
        const orderId = "EG" + Date.now().toString().slice(-6);
        
        // Create order object
        const order = {
            id: orderId,
            paymentId: paymentId,
            otp: otp,
            amount: finalAmount,
            customer: orderData.address.name,
            phone: orderData.address.phone,
            items: orderData.cart,
            deliveryMode: orderData.totals.deliveryMode,
            totals: orderData.totals,
            address: orderData.address,
            delivery: orderData.delivery,
            timestamp: new Date().toISOString(),
            paymentMethod: "razorpay"
        };
        
        // Save order
        saveOrderAndProceed(order, otp);
        
        // Send WhatsApp notification
        sendWhatsAppNotification(order, otp);
    }
    
    function saveOrderAndProceed(order, otp) {
        try {
            // Save to localStorage
            let orders = JSON.parse(localStorage.getItem('easygo-orders') || '[]');
            orders.push(order);
            localStorage.setItem('easygo-orders', JSON.stringify(orders));
            
            // Save for tracking
            localStorage.setItem('easygo-otp', otp);
            localStorage.setItem('easygo-order-id', order.id);
            localStorage.setItem('easygo-delivery-mode', order.deliveryMode);
            
            // Clear cart but keep address for future orders
            localStorage.removeItem('easygo-cart');
            localStorage.removeItem('easygo-cart-items-total');
            
            // Save to delivery system
            saveToDeliverySystem(order, otp);
            
            // Clear any payment failures
            localStorage.removeItem('easygo-payment-failures');
            
            // Show success modal
            document.getElementById('generated-otp').textContent = otp;
            document.getElementById('success-modal').classList.remove('hidden');
            
            // Auto-redirect after 8 seconds
            setTimeout(() => {
                if (!document.getElementById('success-modal').classList.contains('hidden')) {
                    window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
                }
            }, 8000);
            
        } catch (error) {
            console.error("Error saving order:", error);
            showGlobalError("Order saved but encountered an error. Please note your OTP: " + otp, 'warning');
            
            // Still show success modal
            document.getElementById('generated-otp').textContent = otp;
            document.getElementById('success-modal').classList.remove('hidden');
        }
    }
    
    // ENHANCED EVENT LISTENERS
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Payment page loaded");
        
        // Load order data
        if (!loadOrderData()) {
            return;
        }
        
        // Setup event listeners
        setupEventListeners();
        setupAlternativePayments();
        
        // Check for previous payment attempts
        checkPreviousPaymentAttempts();
    });
    
    function setupEventListeners() {
        // Primary payment button
        document.getElementById('razorpay-pay-btn').addEventListener('click', initiateRazorpayPayment);
        
        // QR payment button
        document.getElementById('qr-pay-btn').addEventListener('click', function() {
            showAlternativePaymentMethods();
        });
        
        // Show alternative methods button
        document.getElementById('show-alternative-methods').addEventListener('click', showAlternativePaymentMethods);
        
        // Retry payment button
        document.getElementById('retry-payment').addEventListener('click', function() {
            this.classList.add('hidden');
            initiateRazorpayPayment();
        });
        
        // Go to tracking button
        document.getElementById('go-to-tracking').addEventListener('click', function() {
            window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
        });
        
        // Retry after failure
        document.getElementById('retry-after-failure').addEventListener('click', function() {
            document.getElementById('payment-failed-modal').classList.add('hidden');
            initiateRazorpayPayment();
        });
        
        // Try alternative methods from failure modal
        document.getElementById('try-alternative-methods').addEventListener('click', function() {
            document.getElementById('payment-failed-modal').classList.add('hidden');
            showAlternativePaymentMethods();
        });
        
        // Payment recovery buttons
        document.getElementById('check-status-btn').addEventListener('click', function() {
            document.getElementById('payment-recovery-modal').classList.add('hidden');
            showLoading("Checking payment status...");
            
            // Simulate status check
            setTimeout(() => {
                hideLoading();
                showGlobalError("Payment status: PENDING. If amount was deducted, it will be refunded automatically.", 'info');
            }, 2000);
        });
        
        document.getElementById('retry-payment-btn').addEventListener('click', function() {
            document.getElementById('payment-recovery-modal').classList.add('hidden');
            initiateRazorpayPayment();
        });
        
        document.getElementById('contact-support-btn').addEventListener('click', function() {
            window.open(SUPPORT_WHATSAPP, '_blank');
        });
        
        // Add offline payment detection
        window.addEventListener('offline', function() {
            showGlobalError("You are offline. Please check your internet connection.", 'warning');
        });
        
        window.addEventListener('online', function() {
            showGlobalError("You are back online. You can proceed with payment.", 'info');
            setTimeout(hideGlobalError, 3000);
        });
    }
    
    function checkPreviousPaymentAttempts() {
        const failures = JSON.parse(localStorage.getItem('easygo-payment-failures') || '[]');
        if (failures.length > 0) {
            const lastFailure = failures[failures.length - 1];
            const failureTime = new Date(lastFailure.timestamp);
            const now = new Date();
            const hoursDiff = (now - failureTime) / (1000 * 60 * 60);
            
            if (hoursDiff < 1) {
                showGlobalError("We detected a recent payment issue. Alternative methods are available.", 'info');
            }
        }
    }
    
    // Keep your existing display functions and WhatsApp sending functions
    // ... [Your existing displayCartItems, displayCustomerDetails, displayDeliveryAddress functions] ...
    // ... [Your existing sendWhatsApp and saveToDeliverySystem functions] ...
    
    // DISPLAY FUNCTIONS (copy from your original code)
    function displayCartItems(cart) {
        const orderItems = document.getElementById('order-items');
        if (!orderItems) return;
        
        orderItems.innerHTML = '';
        
        if (cart.length === 0) {
            orderItems.innerHTML = '<p class="text-gray-500 text-center py-4">No items in cart</p>';
            return;
        }
        
        cart.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-xl border border-gray-100';
            
            const quantity = parseInt(item.quantity) || 1;
            
            itemDiv.innerHTML = `
                <div class="flex-1">
                    <p class="font-semibold text-gray-800 text-lg">${item.name || 'Food Item'}</p>
                    <div class="flex items-center gap-4 mt-2">
                        <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">Qty: ${quantity}</span>
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">Pack: ${item.pack || 'Family'}</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 mb-1">Order item</div>
                    <div class="text-sm font-medium text-gray-700">${quantity} item${quantity > 1 ? 's' : ''}</div>
                </div>
            `;
            orderItems.appendChild(itemDiv);
        });
        
        const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total')) || 0;
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'border-t pt-6 mt-6';
        summaryDiv.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <span class="font-medium text-gray-700">Order contains</span>
                    <p class="text-sm text-gray-500">${cart.length} unique item${cart.length > 1 ? 's' : ''}</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 mb-1">Items value</div>
                    <span class="font-bold text-lg text-gray-900">‚Çπ${cartTotal.toFixed(2)}</span>
                </div>
            </div>
        `;
        orderItems.appendChild(summaryDiv);
    }
    
    function displayCustomerDetails(address) {
        const customerDetails = document.getElementById('customer-details');
        if (!customerDetails) return;
        
        customerDetails.innerHTML = '';
        
        if (!address || Object.keys(address).length === 0) {
            customerDetails.innerHTML = `
                <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl">
                    <p class="font-medium">‚ö†Ô∏è Customer details not found</p>
                    <p class="text-sm mt-1">Please go back to address page and enter details</p>
                </div>
            `;
            return;
        }
        
        let detailsHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        `;
        
        if (address.name) {
            detailsHTML += `
                <div class="flex items-start">
                    <span class="text-blue-600 mr-2 text-xl">üë§</span>
                    <div>
                        <div class="text-sm text-blue-500">Name</div>
                        <div class="font-semibold text-gray-800">${address.name}</div>
                    </div>
                </div>
            `;
        }
        
        if (address.phone) {
            detailsHTML += `
                <div class="flex items-start">
                    <span class="text-blue-600 mr-2 text-xl">üì±</span>
                    <div>
                        <div class="text-sm text-blue-500">Phone</div>
                        <div class="font-semibold text-gray-800">${address.phone}</div>
                    </div>
                </div>
            `;
        }
        
        if (address.deliveryMode) {
            const modeText = address.deliveryMode === 'delivery' ? 'Home Delivery' : 'Takeaway';
            const modeIcon = address.deliveryMode === 'delivery' ? 'üõµ' : 'üè™';
            detailsHTML += `
                <div class="flex items-start md:col-span-2">
                    <span class="text-blue-600 mr-2 text-xl">${modeIcon}</span>
                    <div>
                        <div class="text-sm text-blue-500">Order Type</div>
                        <div class="font-semibold text-gray-800">${modeText}</div>
                    </div>
                </div>
            `;
        }
        
        detailsHTML += `
                </div>
            </div>
        `;
        
        customerDetails.innerHTML = detailsHTML;
    }
    
    function displayDeliveryAddress(address, delivery) {
        const deliveryAddress = document.getElementById('delivery-address');
        if (!deliveryAddress) return;
        
        deliveryAddress.innerHTML = '';
        
        const deliveryMode = address.deliveryMode || delivery.mode || 'takeaway';
        
        if (deliveryMode === 'delivery') {
            let addressHTML = `
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <div class="flex items-center mb-3">
                        <span class="text-green-600 mr-2 text-xl">üìç</span>
                        <span class="font-semibold text-gray-800">Delivery Address</span>
                    </div>
            `;
            
            if (address.houseNumber || address.locality) {
                const addressLine1 = `${address.houseNumber || ''}${address.houseNumber && address.locality ? ', ' : ''}${address.locality || ''}`;
                const addressLine2 = address.street ? address.street : '';
                const cityLine = `${address.city || 'Indore'}, ${address.state || 'MP'} - ${address.pincode || ''}`;
                
                if (addressLine1.trim()) {
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Address</div>
                        <div class="font-medium text-gray-800">${addressLine1}</div>
                    </div>`;
                }
                
                if (addressLine2) {
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Street/Landmark</div>
                        <div class="font-medium text-gray-800">${addressLine2}</div>
                    </div>`;
                }
                
                addressHTML += `<div class="mb-2">
                    <div class="text-sm text-gray-600 mb-1">City & Pincode</div>
                    <div class="font-medium text-gray-800">${cityLine}</div>
                </div>`;
                
                if (address.addressType) {
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Address Type</div>
                        <div class="font-medium text-gray-800">${address.addressType}</div>
                    </div>`;
                }
                
                if (delivery.distance) {
                    addressHTML += `<div class="mb-2">
                        <div class="text-sm text-gray-600 mb-1">Distance</div>
                        <div class="font-medium text-gray-800">${delivery.distance} km from restaurant</div>
                    </div>`;
                }
                
                if (delivery.locationLink) {
                    addressHTML += `<div class="mt-4 pt-3 border-t border-green-100">
                        <a href="${delivery.locationLink}" target="_blank" 
                           class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium">
                            <span class="mr-2">üó∫Ô∏è</span>
                            View on Map
                        </a>
                    </div>`;
                }
            } else {
                addressHTML = `
                    <div class="text-center py-4">
                        <p class="text-red-500 font-medium">‚ö†Ô∏è Address details incomplete</p>
                        <p class="text-sm text-gray-600 mt-1">Please update address details</p>
                    </div>
                `;
            }
            
            addressHTML += `</div>`;
            deliveryAddress.innerHTML = addressHTML;
            
        } else {
            deliveryAddress.innerHTML = `
                <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
                    <div class="flex items-center mb-3">
                        <span class="text-purple-600 mr-2 text-xl">üè™</span>
                        <span class="font-semibold text-gray-800">Pickup Details</span>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Pickup Location</div>
                            <div class="font-medium text-gray-800">Prime Square, Omaxe City 1, Indore</div>
                        </div>
                        
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Pickup Timings</div>
                            <div class="font-medium text-gray-800">6:00 PM - 10:00 PM</div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-600 mb-1">Pickup Name</div>
                                <div class="font-medium text-gray-800">${address.name || 'Not specified'}</div>
                            </div>
                            
                            <div>
                                <div class="text-sm text-gray-600 mb-1">Contact Number</div>
                                <div class="font-medium text-gray-800">${address.phone || 'Not specified'}</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-purple-100">
                            <div class="flex items-center text-amber-600">
                                <span class="mr-2">üîê</span>
                                <span class="font-medium">OTP verification required at pickup</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    function sendWhatsAppNotification(order, otp) {
        try {
            let message = `üì¶ *NEW ORDER RECEIVED* üì¶%0A%0A`;
            message += `*Order ID:* ${order.id}%0A`;
            message += `*OTP:* ${otp}%0A`;
            message += `*Amount:* ‚Çπ${order.amount.toFixed(2)}%0A`;
            message += `*Payment ID:* ${order.paymentId}%0A`;
            message += `*Status:* CONFIRMED ‚úÖ%0A%0A`;
            
            // Add items
            message += `*Items Ordered:*%0A`;
            order.items.forEach(item => {
                const quantity = parseInt(item.quantity) || 1;
                const totalPrice = parseFloat(item.total) || 0;
                const pricePerItem = totalPrice / quantity;
                
                message += `‚Ä¢ ${item.name} √ó ${quantity} (${item.pack || 'Standard'})%0A`;
                message += `  Price: ‚Çπ${pricePerItem.toFixed(2)} each ‚Üí Total: ‚Çπ${totalPrice.toFixed(2)}%0A`;
            });
            
            message += `%0A*Payment Breakdown:*%0A`;
            message += `Food Total: ‚Çπ${order.totals?.foodTotal?.toFixed(2) || 0}%0A`;
            
            if (order.totals?.gstFood > 0) {
                message += `GST on Food (5%): ‚Çπ${order.totals.gstFood.toFixed(2)}%0A`;
            }
            
            if (order.deliveryMode === 'delivery' && order.totals?.deliveryCharge > 0) {
                message += `Delivery Charge: ‚Çπ${order.totals.deliveryCharge.toFixed(2)}%0A`;
                if (order.totals?.gstDelivery > 0) {
                    message += `GST on Delivery (18%): ‚Çπ${order.totals.gstDelivery.toFixed(2)}%0A`;
                }
            }
            
            message += `*TOTAL: ‚Çπ${order.amount.toFixed(2)}*%0A%0A`;
            
            // Customer details
            message += `*Customer Details:*%0A`;
            message += `Name: ${order.customer || 'N/A'}%0A`;
            message += `Phone: ${order.phone || 'N/A'}%0A`;
            
            // Delivery/Takeaway info
            if (order.deliveryMode === 'delivery') {
                message += `%0A*üìç Delivery Address:*%0A`;
                
                if (order.address?.houseNumber || order.address?.locality) {
                    message += `${order.address.houseNumber || ''}, ${order.address.locality || ''}%0A`;
                    if (order.address.street) message += `${order.address.street}%0A`;
                    message += `${order.address.city || 'Indore'}, ${order.address.state || 'MP'} - ${order.address.pincode || ''}%0A`;
                    
                    if (order.address.addressType) {
                        message += `Type: ${order.address.addressType}%0A`;
                    }
                }
                
                if (order.delivery?.distance) {
                    message += `Distance: ${order.delivery.distance} km%0A`;
                }
                
            } else {
                message += `%0A*üè™ Takeaway Pickup:*%0A`;
                message += `Prime Square, Omaxe City 1, Indore%0A`;
                message += `Timings: 6:00 PM - 10:00 PM%0A`;
                message += `Customer: ${order.customer || 'N/A'}%0A`;
                message += `Phone: ${order.phone || 'N/A'}%0A`;
                message += `OTP verification required at pickup%0A`;
            }
            
            console.log("WhatsApp message:", decodeURIComponent(message));
            
            // Open WhatsApp
            window.open(`https://wa.me/917651837322?text=${message}`, '_blank');
            
        } catch (error) {
            console.error("Error sending WhatsApp:", error);
        }
    }
    
    function saveToDeliverySystem(order, otp) {
        try {
            let activeOrders = JSON.parse(localStorage.getItem('easygo-active-orders')) || [];
            let allOrders = JSON.parse(localStorage.getItem('easygo-all-orders')) || [];
            
            const deliveryOrder = {
                orderId: order.id,
                razorpayPaymentId: order.paymentId,
                customerName: order.customer || order.address?.name || 'Customer',
                customerPhone: order.phone || order.address?.phone || '',
                totalAmount: order.amount,
                items: order.items.map(item => ({
                    name: item.name,
                    quantity: item.quantity,
                    price: parseFloat(item.total) || 0,
                    pack: item.pack || 'standard'
                })),
                address: order.deliveryMode === 'delivery' ? 
                    `${order.address?.houseNumber || ''}, ${order.address?.locality || ''}, ${order.address?.city || 'Indore'}` : 
                    "Takeaway - Prime Square, Omaxe City 1, Indore",
                deliveryMode: order.deliveryMode || 'takeaway',
                status: 'order-received',
                timestamp: new Date().toISOString(),
                paymentMethod: order.paymentMethod || 'razorpay',
                paymentId: order.paymentId,
                otp: otp,
                deliveryPartner: "EasyGo-Rider",
                deliveryPartnerPhone: "+91 76518 37322"
            };
            
            activeOrders.push(deliveryOrder);
            localStorage.setItem('easygo-active-orders', JSON.stringify(activeOrders));
            
            allOrders.push(deliveryOrder);
            localStorage.setItem('easygo-all-orders', JSON.stringify(allOrders));
            
            console.log("Order saved to delivery system");
            
        } catch (error) {
            console.error("Error saving to delivery system:", error);
        }
    }
</script>
    
</body>
</html>
