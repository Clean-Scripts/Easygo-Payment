<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <!-- Remove Tailwind CDN and use local version -->
    <script>
        // Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981',
                        secondary: '#3B82F6',
                    }
                }
            }
        }
    </script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <title>Easy Go | Secure Payment</title>
    
    <!-- Inline CSS to avoid CDN -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); min-height: 100vh; }
        
        .razorpay-payment-button { display: none !important; }
        
        /* Status Indicator */
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        .payment-success { animation: successPulse 2s infinite; }
        
        /* Loading Spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Alert Overlay */
        .alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .alert-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .alert-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .alert-card.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: all;
        }
        
        /* Notification */
        .notification-card {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .notification-card.show {
            transform: translateX(0);
        }
        
        /* Custom Utility Classes */
        .bg-gradient-primary { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .bg-gradient-secondary { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); }
        .bg-gradient-danger { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
        
        /* Modern Card Styles */
        .card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #e5e7eb;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 1rem;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 1rem;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.3);
        }
        
        /* Grid System */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        
        /* Flex Utilities */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-8 { gap: 2rem; }
        
        /* Padding & Margin */
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        
        .m-4 { margin: 1rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-8 { margin-top: 2rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        
        /* Text & Colors */
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        
        .text-gray-600 { color: #4b5563; }
        .text-gray-800 { color: #1f2937; }
        .text-green-600 { color: #059669; }
        .text-blue-600 { color: #2563eb; }
        .text-white { color: white; }
        
        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-red-50 { background-color: #fef2f2; }
        
        .border { border-width: 1px; }
        .border-t { border-top-width: 1px; }
        .border-gray-100 { border-color: #f3f4f6; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-green-200 { border-color: #bbf7d0; }
        .border-blue-200 { border-color: #bfdbfe; }
        .border-yellow-200 { border-color: #fef08a; }
        .border-red-200 { border-color: #fecaca; }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-3xl { border-radius: 1.5rem; }
        .rounded-full { border-radius: 9999px; }
        
        .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        /* Width & Height */
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .h-20 { height: 5rem; }
        .h-40 { height: 10rem; }
        .min-h-screen { min-height: 100vh; }
        
        /* Position */
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        /* Z-index */
        .z-50 { z-index: 50; }
        
        /* Display */
        .hidden { display: none; }
        .block { display: block; }
        
        /* Overflow */
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        
        /* Cursor */
        .cursor-pointer { cursor: pointer; }
        
        /* Object Fit */
        .object-cover { object-fit: cover; }
        
        /* Transition */
        .transition-all { transition-property: all; }
        .transition-colors { transition-property: background-color, border-color, color; }
        .transition-transform { transition-property: transform; }
        .duration-300 { transition-duration: 300ms; }
        
        /* Transform */
        .hover\:-translate-y-0\.5:hover { transform: translateY(-0.125rem); }
        .hover\:-translate-x-1:hover { transform: translateX(-0.25rem); }
        
        /* Disabled State */
        .disabled\:opacity-50:disabled { opacity: 0.5; }
        .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .grid-cols-1 { grid-template-columns: 1fr; }
            .text-3xl { font-size: 1.5rem; }
            .text-2xl { font-size: 1.25rem; }
            .p-8 { padding: 1rem; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status hidden">
        üîÑ Connecting...
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="card p-8 max-w-md mx-4 text-center">
            <div class="loading-spinner mx-auto mb-6"></div>
            <h3 class="text-2xl font-bold mb-4">Processing Payment</h3>
            <p class="text-gray-600">Please wait while we secure your transaction...</p>
        </div>
    </div>

    <!-- Success Alert Card -->
    <div id="success-alert" class="alert-card">
        <div class="card p-8 max-w-md mx-4 border-2 border-green-200">
            <div class="text-center">
                <div class="text-6xl mb-6">‚úÖ</div>
                <h3 class="text-2xl font-bold mb-4">Payment Successful!</h3>
                <p class="text-gray-600 mb-6">Order confirmed. Please save this OTP:</p>
                
                <div class="text-4xl font-bold text-green-600 mb-6 bg-gray-100 p-4 rounded-2xl payment-success" id="generated-otp">
                    XXX XXX
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-4 mb-6">
                    <p class="text-yellow-800 font-bold mb-2">‚ö†Ô∏è IMPORTANT NOTICE:</p>
                    <p class="text-sm text-yellow-700">
                        <strong>You MUST send the WhatsApp message</strong> to complete your order.
                        <br>Order will NOT be delivered without WhatsApp confirmation.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <button onclick="sendWhatsAppNow()" 
                            class="btn-primary w-full flex items-center justify-center gap-2">
                        <span>üì± Send WhatsApp Now</span>
                    </button>
                    
                    <button onclick="goToTracking()" 
                            class="btn-secondary w-full">
                        Track Your Order ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Alert Card -->
    <div id="error-alert" class="alert-card">
        <div class="card p-8 max-w-md mx-4 border-2 border-red-200">
            <div class="text-center">
                <div class="text-6xl mb-6">‚ö†Ô∏è</div>
                <h3 class="text-2xl font-bold mb-4" id="error-title">Payment Failed</h3>
                <p class="text-gray-600 mb-6" id="error-message">Payment could not be processed.</p>
                
                <div class="bg-red-50 border border-red-200 rounded-2xl p-4 mb-6">
                    <p class="text-red-800 mb-3" id="error-details"></p>
                    <p class="text-sm text-red-700">
                        <strong>Note:</strong> If amount was deducted, it will be refunded within 24-48 hours.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <button onclick="closeAlert('error-alert'); initiatePayment();" 
                            class="btn-secondary w-full">
                        Try Payment Again
                    </button>
                    
                    <button onclick="closeAlert('error-alert')" 
                            class="w-full py-3 bg-gray-200 text-gray-800 rounded-2xl hover:bg-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Overlay -->
    <div class="alert-overlay" id="alert-overlay" onclick="closeAllAlerts()"></div>

    <!-- Notification Card -->
    <div id="success-notification" class="notification-card">
        <div class="bg-gradient-primary text-white p-6 rounded-2xl shadow-xl max-w-sm">
            <div class="flex items-center gap-4">
                <div class="text-3xl">‚úÖ</div>
                <div>
                    <h4 class="font-bold text-lg">Payment Successful!</h4>
                    <p class="text-green-100 text-sm">Order saved to database</p>
                </div>
            </div>
        </div>
    </div>

    <div id="error-notification" class="notification-card">
        <div class="bg-gradient-danger text-white p-6 rounded-2xl shadow-xl max-w-sm">
            <div class="flex items-center gap-4">
                <div class="text-3xl">‚ùå</div>
                <div>
                    <h4 class="font-bold text-lg">Payment Failed</h4>
                    <p class="text-red-100 text-sm" id="error-notification-msg">Please try again</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Header Banner -->
    <header class="relative mb-8">
        <div class="h-40 overflow-hidden">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                 class="w-full h-full object-cover" alt="Easy Go Banner">
        </div>
        <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
            <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                 class="h-20 w-20 rounded-full border-4 border-white shadow-xl bg-white p-1">
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 pt-10 pb-20">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Order Summary -->
            <div class="space-y-8">
                <div class="card p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="mr-3">üì¶</span>
                        Order Summary
                    </h2>
                    
                    <div id="order-items" class="space-y-4 mb-6 max-h-80 overflow-y-auto pr-2">
                        <!-- Items loaded from localStorage -->
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="font-bold mb-4 flex items-center">
                            <span class="mr-2">üë§</span>
                            Customer Details
                        </h3>
                        <div id="customer-details" class="space-y-2">
                            <!-- Details loaded from localStorage -->
                        </div>
                    </div>
                </div>
                
                <div class="card p-8">
                    <h3 class="font-bold mb-4 flex items-center">
                        <span class="mr-2">üìç</span>
                        Order Details
                    </h3>
                    <div id="delivery-address" class="space-y-2">
                        <!-- Address loaded from localStorage -->
                    </div>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div class="space-y-8">
                <div class="card p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="mr-3">üí∞</span>
                        Payment Summary
                    </h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between py-2">
                            <span class="text-gray-700">Food Items Total</span>
                            <span id="food-total" class="font-semibold">‚Çπ0</span>
                        </div>
                        
                        <div class="flex justify-between py-2">
                            <span class="text-gray-700">GST on Food (5%)</span>
                            <span id="gst-food" class="font-semibold">‚Çπ0</span>
                        </div>
                        
                        <!-- Delivery Charges Section -->
                        <div id="delivery-section" class="border-t pt-4 mt-2">
                            <div class="flex justify-between py-2">
                                <span class="text-gray-700">Delivery Charge</span>
                                <span id="delivery-charge" class="font-semibold">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-700">GST on Delivery</span>
                                <span id="gst-delivery" class="font-semibold">‚Çπ0</span>
                            </div>
                            <p id="delivery-note" class="text-xs text-gray-500 mt-1 text-right">
                                <span id="delivery-info"></span>
                            </p>
                        </div>
                        
                        <div class="border-t-2 border-gray-300 pt-4 mt-2">
                            <div class="flex justify-between text-xl font-bold py-2">
                                <span class="text-gray-800">Total Amount Payable</span>
                                <span id="final-total" class="text-green-600">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Options -->
                <div class="card p-8">
                    <div class="text-center mb-8">
                        <div class="inline-block bg-green-50 border border-green-200 text-green-800 px-8 py-4 rounded-2xl mb-4">
                            <div class="text-sm font-medium mb-1">Total to pay</div>
                            <span class="font-bold text-3xl" id="payment-amount">‚Çπ0</span>
                        </div>
                        <p class="text-gray-600">100% Secure Payment via Razorpay</p>
                    </div>
                    
                    <div class="space-y-4 mb-8">
                        <button id="razorpay-pay-btn" 
                                class="btn-secondary w-full py-5 text-xl flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                                onclick="initiatePayment()">
                            <svg class="w-7 h-7 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.436 7.406H1.564a1.25 1.25 0 0 0-1.108 1.831l1.414 2.823a1.25 1.25 0 0 0 1.108.669h19.242a1.25 1.25 0 0 0 1.108-.669l1.414-2.823a1.25 1.25 0 0 0-1.108-1.831z"/>
                                <path d="M2.5 12.406h19v9h-19z"/>
                            </svg>
                            Pay Now - ‚Çπ<span id="pay-amount">0</span>
                        </button>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-4">
                            <p class="text-yellow-800 text-sm font-medium">
                                ‚ö†Ô∏è <strong>Important:</strong> After payment, you MUST send the WhatsApp Message to complete your order. Order will NOT be Delivered without WhatsApp Confirmation.
                            </p>
                        </div>
                        
                        <div class="text-center pt-4">
                            <div class="inline-flex items-center justify-center space-x-3 text-sm text-gray-600 bg-gray-50 px-6 py-3 rounded-full">
                                <span class="flex items-center">
                                    <span class="text-green-500 mr-1">‚úì</span>
                                    Secure
                                </span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>Cards</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>UPI</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span>NetBanking</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Powered by Razorpay | PCI DSS Certified</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 pt-6 border-t">
                        <div class="flex justify-between items-center">
                            <a href="https://clean-scripts.github.io/Easygo-Address/" 
                               class="text-gray-600 hover:text-gray-900 flex items-center group transition-colors">
                                <span class="text-xl mr-2 group-hover:-translate-x-1 transition-transform">‚Üê</span>
                                <span>Back to Address</span>
                            </a>
                            <button id="retry-payment" 
                                    class="text-blue-600 hover:text-blue-800 hidden flex items-center group"
                                    onclick="initiatePayment()">
                                <span class="mr-2 group-hover:rotate-180 transition-transform">üîÑ</span>
                                <span>Retry Payment</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Delivering Freshness & Speed !</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go | All Rights Reserved
                    </p>
                    <div class="mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<!-- Firebase & Payment Logic -->
<script>
// ==================== CONFIGURATION ====================
// IMPORTANT: In production, these should be loaded from a secure server endpoint
// For now, we'll use localStorage with encryption for sensitive data

// Try to get encrypted config from localStorage
function getEncryptedConfig() {
    try {
        // Check if config exists in localStorage
        const configData = localStorage.getItem('easygo_payment_config');
        if (configData) {
            try {
                // Try to parse as JSON first
                const parsed = JSON.parse(configData);
                if (parsed && parsed.key) {
                    return parsed;
                }
            } catch (e) {
                // If not JSON, try simple base64 decode
                try {
                    const decoded = atob(configData);
                    return JSON.parse(decoded);
                } catch (e2) {
                    console.log("Could not decode config");
                }
            }
        }
    } catch (error) {
        console.error("Error reading config:", error);
    }
    
    // Fallback to hardcoded values (REMOVE IN PRODUCTION)
    return {
        // Firebase Config (Replace with your actual values)
        firebase: {
            apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
            authDomain: "easygo-10f4b.firebaseapp.com",
            databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "easygo-10f4b",
            storageBucket: "easygo-10f4b.firebasestorage.app",
            messagingSenderId: "197660067542",
            appId: "1:197660067542:web:6c616efb479b122f1f6b77"
        },
        // Razorpay Config
        razorpay: {
            key_id: "rzp_live_RySoaT17nxFQSV",
            restaurant_phone: "917651837322"
        }
    };
}

// Encrypt and save config to localStorage
function saveEncryptedConfig(config) {
    try {
        const encrypted = btoa(JSON.stringify(config));
        localStorage.setItem('easygo_payment_config', encrypted);
        console.log("Config saved securely");
    } catch (error) {
        console.error("Error saving config:", error);
    }
}

// Initialize configuration
let CONFIG = getEncryptedConfig();

// Firebase variables
let database;
let isFirebaseConnected = false;

// Payment variables
let orderData = {};
let finalAmount = 0;
let paymentProcessing = false;
let currentOrder = null;
let whatsappSent = false;

// ==================== SECURE INITIALIZATION ====================
async function initializeSecurity() {
    // Check if config needs to be loaded from server
    try {
        // In production, you would fetch from your secure endpoint
        // Example:
        // const response = await fetch('https://your-api.com/config');
        // const serverConfig = await response.json();
        // CONFIG = serverConfig;
        // saveEncryptedConfig(CONFIG);
        
        console.log("Security initialized");
        return true;
    } catch (error) {
        console.error("Security initialization error:", error);
        return false;
    }
}

// ==================== FIREBASE FUNCTIONS ====================
function initializeFirebase() {
    try {
        // Initialize with config
        const app = firebase.initializeApp(CONFIG.firebase);
        database = firebase.database();
        
        // Monitor connection status
        const connectedRef = database.ref(".info/connected");
        connectedRef.on("value", function(snap) {
            const statusElement = document.getElementById('firebaseStatus');
            
            if (snap.val() === true) {
                isFirebaseConnected = true;
                statusElement.textContent = "‚úÖ Connected to Database";
                statusElement.className = "firebase-status bg-gradient-primary text-white";
                console.log("Firebase connected - Ready to process payments");
                
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 3000);
            } else {
                isFirebaseConnected = false;
                statusElement.textContent = "‚ùå Database Disconnected";
                statusElement.className = "firebase-status bg-gradient-danger text-white";
                statusElement.classList.remove('hidden');
            }
        });
        
        // Show initial status
        const statusElement = document.getElementById('firebaseStatus');
        statusElement.classList.remove('hidden');
        statusElement.textContent = "üîÑ Connecting to Database...";
        statusElement.className = "firebase-status bg-yellow-500 text-white";
        
        return true;
        
    } catch (error) {
        console.error("Firebase initialization error:", error);
        document.getElementById('firebaseStatus').classList.add('hidden');
        return false;
    }
}

async function saveOrderToFirebase(orderData) {
    try {
        // Create unique order ID
        const orderId = `EG${Date.now()}${Math.floor(Math.random() * 1000)}`;
        const timestamp = Date.now();
        const otp = generateOTP();
        
        // Prepare order data for Firebase
        const firebaseOrderData = {
            orderId: orderId,
            customerName: orderData.customerName || orderData.address?.name || "Customer",
            customerPhone: orderData.customerPhone || orderData.address?.phone || "",
            customerEmail: orderData.customerEmail || "",
            items: orderData.items || [],
            totalAmount: orderData.amount || orderData.totalAmount || 0,
            deliveryMode: orderData.deliveryMode || orderData.totals?.deliveryMode || "takeaway",
            address: orderData.deliveryMode === 'delivery' ? 
                `${orderData.address?.houseNumber || ''}, ${orderData.address?.locality || ''}, ${orderData.address?.city || 'Indore'}` : 
                "Takeaway - Prime Square",
            paymentMethod: "Razorpay",
            paymentStatus: "pending",
            status: "pending",
            otp: otp,
            gstFood: orderData.totals?.gstFood || 0,
            deliveryCharge: orderData.totals?.deliveryCharge || 0,
            gstDelivery: orderData.totals?.gstDelivery || 0,
            foodTotal: orderData.totals?.foodTotal || 0,
            distance: orderData.delivery?.distance || 0,
            createdAt: timestamp,
            updatedAt: timestamp,
            date: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
            timeline: {
                created: {
                    status: "created",
                    message: "Order created and payment initiated",
                    timestamp: timestamp
                }
            }
        };
        
        console.log("Saving order to Firebase:", orderId);
        
        // Save to Firebase
        await database.ref(`orders/${orderId}`).set(firebaseOrderData);
        
        console.log("Order saved successfully to Firebase with ID:", orderId);
        showNotification('success', 'Order saved to database');
        
        return { orderId, otp };
        
    } catch (error) {
        console.error("Error saving order to Firebase:", error);
        console.error("Error details:", error.message, error.code);
        
        // Check Firebase rules
        if (error.code === 'PERMISSION_DENIED') {
            const errorMsg = "Database permission denied. Please check Firebase rules.";
            console.error(errorMsg);
            showNotification('error', errorMsg);
            
            // Fallback to localStorage
            return saveOrderToLocalStorage(orderData);
        }
        
        showNotification('error', 'Failed to save order. Please contact support.');
        return null;
    }
}

function generateOTP() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

function saveOrderToLocalStorage(orderData) {
    try {
        const orderId = `LOCAL${Date.now()}${Math.floor(Math.random() * 1000)}`;
        const timestamp = Date.now();
        const otp = generateOTP();
        
        const localOrderData = {
            orderId: orderId,
            customerName: orderData.customerName || orderData.address?.name || "Customer",
            customerPhone: orderData.customerPhone || orderData.address?.phone || "",
            items: orderData.items || [],
            totalAmount: orderData.amount || orderData.totalAmount || 0,
            deliveryMode: orderData.deliveryMode || orderData.totals?.deliveryMode || "takeaway",
            address: orderData.address || "Takeaway - Prime Square",
            paymentMethod: "Razorpay",
            paymentStatus: "pending",
            status: "pending",
            otp: otp,
            createdAt: timestamp,
            updatedAt: timestamp,
            date: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
        };
        
        // Save to localStorage as backup
        localStorage.setItem(`easygo-local-order-${orderId}`, JSON.stringify(localOrderData));
        
        console.log("Order saved to localStorage as backup:", orderId);
        showNotification('warning', 'Using local storage backup');
        
        return { orderId, otp };
        
    } catch (error) {
        console.error("Error saving to localStorage:", error);
        return null;
    }
}

async function updateOrderPaymentStatus(orderId, paymentData) {
    try {
        if (!isFirebaseConnected || !orderId) {
            console.log("‚ö†Ô∏è Firebase not connected or no orderId, updating localStorage");
            return updateLocalOrderPaymentStatus(orderId, paymentData);
        }
        
        const updates = {
            paymentStatus: paymentData.status,
            paymentId: paymentData.paymentId,
            razorpayPaymentId: paymentData.razorpayPaymentId,
            updatedAt: Date.now(),
            status: 'confirmed'
        };
        
        // Add to timeline
        const timelineUpdate = {
            status: 'payment_confirmed',
            message: `Payment successful: ${paymentData.paymentId}`,
            timestamp: Date.now()
        };
        
        await database.ref(`orders/${orderId}`).update(updates);
        await database.ref(`orders/${orderId}/timeline/payment_confirmed`).set(timelineUpdate);
        
        console.log("Payment status updated for order:", orderId);
        return true;
        
    } catch (error) {
        console.error("Error updating payment status:", error);
        
        // Fallback to localStorage
        if (error.code === 'PERMISSION_DENIED') {
            return updateLocalOrderPaymentStatus(orderId, paymentData);
        }
        
        return false;
    }
}

function updateLocalOrderPaymentStatus(orderId, paymentData) {
    try {
        // Get order from localStorage
        const orderKey = `easygo-local-order-${orderId}`;
        const orderJson = localStorage.getItem(orderKey);
        
        if (orderJson) {
            const order = JSON.parse(orderJson);
            order.paymentStatus = paymentData.status;
            order.paymentId = paymentData.paymentId;
            order.razorpayPaymentId = paymentData.razorpayPaymentId;
            order.updatedAt = Date.now();
            order.status = 'confirmed';
            
            localStorage.setItem(orderKey, JSON.stringify(order));
            console.log("Payment status updated in localStorage for order:", orderId);
            return true;
        }
        
        return false;
    } catch (error) {
        console.error("Error updating localStorage payment status:", error);
        return false;
    }
}

// ==================== UI FUNCTIONS ====================
function showAlert(alertId) {
    document.getElementById(alertId).classList.add('active');
    document.getElementById('alert-overlay').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeAlert(alertId) {
    document.getElementById(alertId).classList.remove('active');
    document.getElementById('alert-overlay').classList.remove('active');
    document.body.style.overflow = 'auto';
}

function closeAllAlerts() {
    document.querySelectorAll('.alert-card').forEach(alert => {
        alert.classList.remove('active');
    });
    document.getElementById('alert-overlay').classList.remove('active');
    document.body.style.overflow = 'auto';
}

function showNotification(type, message = '') {
    const notificationId = type === 'success' ? 'success-notification' : 'error-notification';
    const notification = document.getElementById(notificationId);
    
    if (message && type === 'error') {
        document.getElementById('error-notification-msg').textContent = message.substring(0, 50);
    }
    
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function showLoading() {
    document.getElementById('loading-overlay').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.add('hidden');
}

// ==================== ORDER DATA LOADING ====================
function loadOrderData() {
    try {
        // Load from localStorage (from previous pages)
        const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
        const address = JSON.parse(localStorage.getItem('easygo-address') || '{}');
        const delivery = JSON.parse(localStorage.getItem('easygo-delivery') || '{}');
        
        if (cart.length === 0) {
            showAlert('error-alert');
            document.getElementById('error-title').textContent = 'Empty Cart';
            document.getElementById('error-message').textContent = 'Your cart is empty. Please add items first.';
            document.getElementById('razorpay-pay-btn').disabled = true;
            return false;
        }
        
        // Get delivery mode
        const deliveryMode = address.deliveryMode || 'takeaway';
        
        // Calculate food total
        let foodTotal = 0;
        cart.forEach(item => {
            const unitPrice = parseFloat(item.unitPrice) || parseFloat(item.price) || 0;
            const quantity = parseInt(item.quantity) || 1;
            const itemTotal = unitPrice * quantity;
            foodTotal += itemTotal || 0;
        });
        
        if (foodTotal <= 0) {
            foodTotal = parseFloat(localStorage.getItem('easygo-cart-items-total')) || 0;
        }
        
        if (foodTotal <= 0) {
            showNotification('error', 'Invalid order amount');
            return false;
        }
        
        const gstFood = Math.round((foodTotal * 0.05) * 100) / 100;
        
        // Delivery charges calculation
        let deliveryCharge = 0;
        let gstDelivery = 0;
        let deliveryInfo = "";
        
        if (deliveryMode === 'delivery') {
            const distance = parseFloat(delivery.distance) || 0;
            const cartTotal = foodTotal;
            
            // Delivery logic from address page
            if (distance <= 1) {
                deliveryCharge = 9;
                deliveryInfo = "Fixed ‚Çπ9 delivery (GST included)";
                gstDelivery = 0;
            } else if (distance <= 4 && cartTotal > 199) {
                deliveryCharge = 0;
                deliveryInfo = "Free delivery (order above ‚Çπ199)";
                gstDelivery = 0;
            } else {
                deliveryCharge = Math.min(20 + (distance * 10), 80);
                gstDelivery = Math.round((deliveryCharge * 0.18) * 100) / 100;
                deliveryInfo = `${distance.toFixed(1)}km delivery`;
            }
        }
        
        finalAmount = parseFloat((foodTotal + gstFood + deliveryCharge + gstDelivery).toFixed(2));
        
        if (finalAmount < 1) {
            showNotification('error', 'Invalid total amount');
            return false;
        }
        
        // Prepare items array for Firebase
        const itemsArray = cart.map(item => ({
            name: item.name,
            quantity: parseInt(item.quantity) || 1,
            pack: item.pack || 'Standard',
            unitPrice: parseFloat(item.unitPrice) || parseFloat(item.price) || 0,
            total: (parseFloat(item.unitPrice) || parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1)
        }));
        
        // Store order data
        orderData = { 
            cart, 
            address, 
            delivery, 
            amount: finalAmount,
            customerName: address.name,
            customerPhone: address.phone,
            customerEmail: address.email,
            deliveryMode: deliveryMode,
            items: itemsArray,
            totals: {
                foodTotal,
                gstFood,
                deliveryCharge,
                gstDelivery,
                deliveryMode,
                distance: delivery.distance
            }
        };
        
        // Update UI
        displayCartItems(cart);
        displayCustomerDetails(address, deliveryMode);
        displayDeliveryAddress(address, delivery, deliveryMode);
        updatePaymentUI(foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode, deliveryInfo);
        
        console.log("Order loaded successfully");
        return true;
        
    } catch (error) {
        console.error("Error loading order:", error);
        showNotification('error', 'Failed to load order data');
        return false;
    }
}

function updatePaymentUI(foodTotal, gstFood, deliveryCharge, gstDelivery, deliveryMode, deliveryInfo) {
    document.getElementById('food-total').textContent = `‚Çπ${foodTotal.toFixed(2)}`;
    document.getElementById('gst-food').textContent = `‚Çπ${gstFood.toFixed(2)}`;
    
    if (deliveryMode === 'delivery') {
        document.getElementById('delivery-section').classList.remove('hidden');
        document.getElementById('delivery-charge').textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
        
        if (deliveryCharge === 9) {
            document.getElementById('gst-delivery').textContent = '‚Çπ0.00 (Included in ‚Çπ9)';
        } else {
            document.getElementById('gst-delivery').textContent = `‚Çπ${gstDelivery.toFixed(2)}`;
        }
        
        document.getElementById('delivery-info').textContent = deliveryInfo;
    } else {
        document.getElementById('delivery-section').classList.add('hidden');
    }
    
    document.getElementById('final-total').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
    document.getElementById('payment-amount').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
    document.getElementById('pay-amount').textContent = finalAmount.toFixed(2);
}

function displayCartItems(cart) {
    const orderItems = document.getElementById('order-items');
    if (!orderItems) return;
    
    orderItems.innerHTML = '';
    
    cart.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-xl border border-gray-100 fade-in';
        
        const quantity = parseInt(item.quantity) || 1;
        const unitPrice = parseFloat(item.unitPrice) || parseFloat(item.price) || 0;
        const totalPrice = unitPrice * quantity;
        
        itemDiv.innerHTML = `
            <div class="flex-1">
                <p class="font-semibold text-gray-800 text-lg">${item.name || 'Food Item'}</p>
                <div class="flex items-center gap-4 mt-2">
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">Qty: ${quantity}</span>
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">Pack: ${item.pack || 'Family'}</span>
                </div>
                <p class="text-sm text-gray-600 mt-2">‚Çπ${unitPrice.toFixed(2)} √ó ${quantity}</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500 mb-1">Price</div>
                <div class="text-lg font-bold text-gray-800">‚Çπ${totalPrice.toFixed(2)}</div>
            </div>
        `;
        orderItems.appendChild(itemDiv);
    });
}

function displayCustomerDetails(address, deliveryMode) {
    const customerDetails = document.getElementById('customer-details');
    if (!customerDetails) return;
    
    let detailsHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    `;
    
    if (address.name) {
        detailsHTML += `
            <div class="flex items-start">
                <span class="text-blue-600 mr-2 text-xl">üë§</span>
                <div>
                    <div class="text-sm text-blue-500">Name</div>
                    <div class="font-semibold text-gray-800">${address.name}</div>
                </div>
            </div>
        `;
    }
    
    if (address.phone) {
        detailsHTML += `
            <div class="flex items-start">
                <span class="text-blue-600 mr-2 text-xl">üì±</span>
                <div>
                    <div class="text-sm text-blue-500">Phone</div>
                    <div class="font-semibold text-gray-800">${address.phone}</div>
                </div>
            </div>
        `;
    }
    
    const modeText = deliveryMode === 'delivery' ? 'Home Delivery' : 'Takeaway';
    const modeIcon = deliveryMode === 'delivery' ? 'üõµ' : 'üè™';
    detailsHTML += `
        <div class="flex items-start md:col-span-2">
            <span class="text-blue-600 mr-2 text-xl">${modeIcon}</span>
            <div>
                <div class="text-sm text-blue-500">Order Type</div>
                <div class="font-semibold text-gray-800">${modeText}</div>
            </div>
        </div>
    `;
    
    detailsHTML += `
            </div>
        </div>
    `;
    
    customerDetails.innerHTML = detailsHTML;
}

function displayDeliveryAddress(address, delivery, deliveryMode) {
    const deliveryAddress = document.getElementById('delivery-address');
    if (!deliveryAddress) return;
    
    if (deliveryMode === 'delivery') {
        let addressHTML = `
            <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                <div class="flex items-center mb-3">
                    <span class="text-green-600 mr-2 text-xl">üìç</span>
                    <span class="font-semibold text-gray-800">Delivery Address</span>
                </div>
        `;
        
        if (address.houseNumber || address.locality) {
            const addressLine1 = `${address.houseNumber || ''}${address.houseNumber && address.locality ? ', ' : ''}${address.locality || ''}`;
            const addressLine2 = address.street ? address.street : '';
            const cityLine = `${address.city || 'Indore'}, ${address.state || 'MP'} - ${address.pincode || ''}`;
            
            if (addressLine1.trim()) {
                addressHTML += `<div class="mb-2">
                    <div class="text-sm text-gray-600 mb-1">Address</div>
                    <div class="font-medium text-gray-800">${addressLine1}</div>
                </div>`;
            }
            
            if (addressLine2) {
                addressHTML += `<div class="mb-2">
                    <div class="text-sm text-gray-600 mb-1">Street/Landmark</div>
                    <div class="font-medium text-gray-800">${addressLine2}</div>
                </div>`;
            }
            
            addressHTML += `<div class="mb-2">
                <div class="text-sm text-gray-600 mb-1">City & Pincode</div>
                <div class="font-medium text-gray-800">${cityLine}</div>
            </div>`;
            
            if (address.addressType) {
                addressHTML += `<div class="mb-2">
                    <div class="text-sm text-gray-600 mb-1">Address Type</div>
                    <div class="font-medium text-gray-800">${address.addressType}</div>
                </div>`;
            }
            
            if (delivery.distance) {
                addressHTML += `<div class="mb-2">
                    <div class="text-sm text-gray-600 mb-1">Distance</div>
                    <div class="font-medium text-gray-800">${delivery.distance} km from restaurant</div>
                </div>`;
            }
        }
        
        addressHTML += `</div>`;
        deliveryAddress.innerHTML = addressHTML;
        
    } else {
        deliveryAddress.innerHTML = `
            <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
                <div class="flex items-center mb-3">
                    <span class="text-purple-600 mr-2 text-xl">üè™</span>
                    <span class="font-semibold text-gray-800">Pickup Details</span>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Pickup Location</div>
                        <div class="font-medium text-gray-800">Prime Square, Omaxe City 1, Indore</div>
                    </div>
                    
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Pickup Timings</div>
                        <div class="font-medium text-gray-800">5:45 PM - 11:30 PM</div>
                    </div>
                </div>
            </div>
        `;
    }
}

// ==================== RAZORPAY PAYMENT ====================
async function initiatePayment() {
    if (paymentProcessing) {
        showNotification('error', 'Payment already in progress');
        return;
    }
    
    if (!orderData.address?.phone) {
        showNotification('error', 'Phone number required');
        return;
    }
    
    if (finalAmount < 1) {
        showNotification('error', 'Invalid payment amount');
        return;
    }
    
    paymentProcessing = true;
    showLoading();
    
    try {
        console.log("Initiating payment for amount:", finalAmount);
        
        // First save order to Firebase (with pending status)
        const orderResult = await saveOrderToFirebase({
            customerPhone: orderData.address.phone,
            customerName: orderData.address.name,
            items: orderData.items,
            deliveryMode: orderData.deliveryMode,
            address: orderData.deliveryMode === 'delivery' ? 
                `${orderData.address.houseNumber || ''}, ${orderData.address.locality || ''}, ${orderData.address.city || 'Indore'}` : 
                "Takeaway - Prime Square",
            amount: finalAmount,
            totals: orderData.totals
        });
        
        if (!orderResult) {
            throw new Error('Failed to save order');
        }
        
        const { orderId, otp } = orderResult;
        console.log("Order saved with ID:", orderId, "OTP:", otp);
        
        // Store Firebase order ID in localStorage
        localStorage.setItem('easygo-firebase-order-id', orderId);
        localStorage.setItem('easygo-current-order-data', JSON.stringify(orderData));
        localStorage.setItem('easygo-order-otp', otp);
        
        // Create Razorpay order
        const options = {
            key: CONFIG.razorpay.key_id,
            amount: Math.round(finalAmount * 100), // Amount in paise
            currency: "INR",
            name: "Easy Go",
            description: `Order #${orderId} - ${orderData.address.name}`,
            prefill: {
                name: orderData.address.name || "Customer",
                contact: orderData.address.phone || "",
                email: orderData.address.email || "customer@easygo.com"
            },
            handler: async function(response) {
                console.log("Payment success response:", response);
                await handlePaymentSuccess(response.razorpay_payment_id, orderId, otp, response);
            },
            theme: { 
                color: "#10B981"
            },
            modal: {
                ondismiss: function() {
                    console.log("Payment modal dismissed");
                    paymentProcessing = false;
                    hideLoading();
                    document.getElementById('retry-payment').classList.remove('hidden');
                    showNotification('info', 'Payment cancelled');
                }
            }
        };
        
        console.log("Opening Razorpay with options (key hidden for security)");
        
        const rzp = new Razorpay(options);
        
        rzp.on('payment.failed', async function(response) {
            console.error("Payment failed:", response);
            paymentProcessing = false;
            hideLoading();
            
            // Update Firebase with failed status
            if (orderId) {
                try {
                    await updateOrderPaymentStatus(orderId, {
                        status: 'failed',
                        paymentId: response.error.metadata?.payment_id || 'failed',
                        razorpayPaymentId: response.error.metadata?.payment_id || 'failed'
                    });
                } catch (error) {
                    console.error("Failed to update payment status:", error);
                }
            }
            
            showAlert('error-alert');
            document.getElementById('error-details').textContent = response.error.description || 'Payment failed';
            document.getElementById('retry-payment').classList.remove('hidden');
        });
        
        rzp.open();
        
    } catch (error) {
        console.error("Payment initiation error:", error);
        paymentProcessing = false;
        hideLoading();
        
        showAlert('error-alert');
        document.getElementById('error-title').textContent = 'Payment Error';
        document.getElementById('error-message').textContent = 'Unable to process payment';
        document.getElementById('error-details').textContent = error.message || 'Unknown error occurred';
        
        document.getElementById('retry-payment').classList.remove('hidden');
    }
}

async function handlePaymentSuccess(paymentId, firebaseOrderId, otp, response) {
    paymentProcessing = false;
    hideLoading();
    
    console.log("Payment success:", paymentId, firebaseOrderId);
    
    if (!paymentId || !firebaseOrderId) {
        showAlert('error-alert');
        document.getElementById('error-details').textContent = 'No payment ID received';
        return;
    }
    
    try {
        // Update Firebase with successful payment
        const paymentUpdated = await updateOrderPaymentStatus(firebaseOrderId, {
            status: 'success',
            paymentId: paymentId,
            razorpayPaymentId: paymentId
        });
        
        if (!paymentUpdated) {
            console.log("Payment status update failed, but continuing...");
        }
        
        // Create complete order object
        currentOrder = {
            id: firebaseOrderId,
            paymentId: paymentId,
            orderId: firebaseOrderId,
            otp: otp,
            amount: finalAmount,
            customer: orderData.address.name,
            phone: orderData.address.phone,
            items: orderData.items,
            deliveryMode: orderData.deliveryMode,
            totals: orderData.totals,
            address: orderData.address,
            delivery: orderData.delivery,
            timestamp: new Date().toISOString(),
            paymentMethod: "razorpay",
            status: "confirmed",
            razorpaySignature: response.razorpay_signature || ""
        };
        
        // Save all data to localStorage for backup
        localStorage.setItem('easygo-otp', otp);
        localStorage.setItem('easygo-order-id', firebaseOrderId);
        localStorage.setItem('easygo-payment-id', paymentId);
        localStorage.setItem('easygo-last-order', JSON.stringify(currentOrder));
        localStorage.setItem('easygo-payment-success', 'true');
        localStorage.setItem('easygo-last-payment-time', Date.now().toString());
        
        // Clear cart from localStorage
        localStorage.removeItem('easygo-cart');
        localStorage.removeItem('easygo-cart-items-total');
        
        // Update UI with OTP
        document.getElementById('generated-otp').textContent = otp;
        
        // Show success alert
        showAlert('success-alert');
        showNotification('success', 'Payment successful!');
        
        // Auto-send WhatsApp after 2 seconds
        setTimeout(() => {
            sendWhatsAppNow();
        }, 2000);
        
    } catch (error) {
        console.error("Payment processing error:", error);
        
        // Even if there's an error updating, show success if payment went through
        if (paymentId) {
            showAlert('success-alert');
            document.getElementById('generated-otp').textContent = otp || "123456";
            showNotification('warning', 'Payment successful but update failed');
        } else {
            showAlert('error-alert');
            document.getElementById('error-details').textContent = 'Payment successful but order update failed: ' + error.message;
        }
    }
}

// ==================== WHATSAPP FUNCTIONS ====================
function sendWhatsAppNow() {
    if (!currentOrder) {
        // Try to get order from localStorage
        const lastOrderJson = localStorage.getItem('easygo-last-order');
        if (lastOrderJson) {
            currentOrder = JSON.parse(lastOrderJson);
        } else {
            showNotification('error', 'No order found');
            return false;
        }
    }
    
    // Create WhatsApp message
    let message = createWhatsAppMessage(currentOrder);
    
    // Create WhatsApp URL
    const whatsappURL = `https://wa.me/${CONFIG.razorpay.restaurant_phone}?text=${encodeURIComponent(message)}`;
    
    // Open WhatsApp in new tab
    window.open(whatsappURL, '_blank', 'noopener,noreferrer');
    
    // Mark WhatsApp as sent
    whatsappSent = true;
    
    // Update localStorage
    localStorage.setItem('easygo-whatsapp-sent', 'true');
    localStorage.setItem('easygo-whatsapp-sent-time', Date.now().toString());
    
    // Update Firebase if connected
    if (isFirebaseConnected && currentOrder.id) {
        try {
            database.ref(`orders/${currentOrder.id}`).update({
                whatsappSent: true,
                whatsappSentTime: new Date().toISOString(),
                updatedAt: Date.now()
            });
        } catch (error) {
            console.error("Error updating WhatsApp status in Firebase:", error);
        }
    }
    
    showNotification('success', 'WhatsApp opened successfully');
    return true;
}

function createWhatsAppMessage(order) {
    let message = "";
    
    // Header with emojis
    message += "üì¶ *NEW ORDER RECEIVED* üì¶\n\n";
    
    // Order Details
    message += `*Order ID:* ${order.id}\n`;
    message += `*OTP:* ${order.otp}\n`;
    message += `*Amount:* ‚Çπ${order.amount.toFixed(2)}\n`;
    message += `*Payment ID:* ${order.paymentId}\n`;
    message += `*Status:* CONFIRMED ‚úÖ\n\n`;
    
    // Items Ordered
    if (order.items && order.items.length > 0) {
        message += `*ITEMS ORDERED:*\n`;
        message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        order.items.forEach(item => {
            const quantity = parseInt(item.quantity) || 1;
            const unitPrice = parseFloat(item.unitPrice) || 0;
            const totalPrice = parseFloat(item.total) || (unitPrice * quantity);
            
            message += `‚Ä¢ ${item.name} √ó ${quantity}\n`;
            message += `  Pack: ${item.pack || 'Standard'}\n`;
            message += `  Price: ‚Çπ${unitPrice.toFixed(2)} √ó ${quantity} = ‚Çπ${totalPrice.toFixed(2)}\n\n`;
        });
    }
    
    // Payment Breakdown
    message += `*PAYMENT BREAKDOWN:*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    
    if (order.totals) {
        message += `Food Total: ‚Çπ${order.totals.foodTotal?.toFixed(2) || '0.00'}\n`;
        message += `GST on Food (5%): ‚Çπ${order.totals.gstFood?.toFixed(2) || '0.00'}\n`;
        
        if (order.deliveryMode === 'delivery') {
            message += `Delivery Charge: ‚Çπ${order.totals.deliveryCharge?.toFixed(2) || '0.00'}\n`;
            if (order.totals.deliveryCharge === 9) {
                message += `GST on Delivery: Included in ‚Çπ9\n`;
            } else {
                message += `GST on Delivery (18%): ‚Çπ${order.totals.gstDelivery?.toFixed(2) || '0.00'}\n`;
            }
        }
    }
    
    message += `*TOTAL: ‚Çπ${order.amount.toFixed(2)}*\n\n`;
    
    // Customer Details
    message += `*CUSTOMER DETAILS:*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üë§ Name: ${order.customer || 'Customer'}\n`;
    message += `üì± Phone: ${order.phone || 'Not provided'}\n`;
    message += `üí≥ Payment: Razorpay (Online)\n\n`;
    
    // Delivery/Pickup Details
    if (order.deliveryMode === 'delivery' && order.address) {
        message += `*üìç DELIVERY ADDRESS:*\n`;
        message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        
        // Build address
        const addressParts = [];
        if (order.address.houseNumber) addressParts.push(order.address.houseNumber);
        if (order.address.floorNumber) addressParts.push(`Floor ${order.address.floorNumber}`);
        if (order.address.street) addressParts.push(order.address.street);
        if (order.address.locality) addressParts.push(order.address.locality);
        if (order.address.city) addressParts.push(order.address.city);
        if (order.address.state) addressParts.push(order.address.state);
        if (order.address.pincode) addressParts.push(order.address.pincode);
        
        if (addressParts.length > 0) {
            message += addressParts.join(', ') + '\n';
        } else {
            message += "Address not provided\n";
        }
        
        if (order.delivery?.distance) {
            message += `Distance: ${order.delivery.distance} km\n`;
        }
    } else {
        message += `*üè™ PICKUP DETAILS:*\n`;
        message += `Prime Square, Omaxe City 1, Indore\n`;
        message += `Timings: 5:45 PM - 11:30 PM\n`;
        message += `Customer: ${order.customer || 'Customer'}\n`;
        message += `Phone: ${order.phone || 'Not provided'}\n`;
        message += `üìã OTP verification required at pickup\n`;
    }
    
    // Order Time
    message += `\n*üìÖ ORDER TIME:*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `‚è∞ ${new Date().toLocaleTimeString()}\n`;
    message += `üìÖ ${new Date().toLocaleDateString()}\n\n`;
    
    // Important Notice
    message += `‚ö†Ô∏è *IMPORTANT:* Customer has been instructed to send this message.\n`;
    message += `Order will not be delivered without WhatsApp confirmation.\n\n`;
    
    message += `_Order placed via EasyGo Payment System_`;
    
    return message;
}

function goToTracking() {
    if (!whatsappSent) {
        const whatsappSentStorage = localStorage.getItem('easygo-whatsapp-sent');
        if (whatsappSentStorage !== 'true') {
            const confirmGo = confirm("‚ö†Ô∏è You haven't sent the WhatsApp message!\n\nYour order will NOT be delivered without WhatsApp confirmation.\n\nSend WhatsApp now?");
            if (confirmGo) {
                sendWhatsAppNow();
                return;
            }
        }
    }
    
    // Store that we just completed payment
    sessionStorage.setItem('just_paid', 'true');
    
    // Redirect to tracking page
    window.location.href = 'https://clean-scripts.github.io/Easygo-Track/';
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log("Payment page loaded - Production Mode");
    
    // Initialize security first
    initializeSecurity().then(() => {
        console.log("Security initialized successfully");
        
        // Initialize Firebase
        if (initializeFirebase()) {
            console.log("Firebase initialized successfully");
        } else {
            console.warn("Firebase initialization failed, using localStorage backup");
            showNotification('warning', 'Using secure offline mode');
        }
        
        // Load order data
        if (!loadOrderData()) {
            document.getElementById('razorpay-pay-btn').disabled = true;
            showNotification('error', 'Failed to load order data');
        } else {
            console.log("Order data loaded successfully");
            console.log("Final amount: ‚Çπ" + finalAmount);
        }
    });
    
    // Setup event listeners
    document.getElementById('razorpay-pay-btn').addEventListener('click', function(e) {
        e.preventDefault();
        initiatePayment();
    });
    
    // Check if there's a pending order in localStorage
    const paymentSuccess = localStorage.getItem('easygo-payment-success');
    const lastOrderJson = localStorage.getItem('easygo-last-order');
    
    if (paymentSuccess === 'true' && lastOrderJson) {
        try {
            currentOrder = JSON.parse(lastOrderJson);
            const otp = localStorage.getItem('easygo-otp') || currentOrder.otp || "123456";
            document.getElementById('generated-otp').textContent = otp;
            showAlert('success-alert');
            showNotification('info', 'Previous order found');
        } catch (error) {
            console.error("Error loading previous order:", error);
        }
    }
});

// Make functions available globally
window.initiatePayment = initiatePayment;
window.sendWhatsAppNow = sendWhatsAppNow;
window.goToTracking = goToTracking;
window.closeAlert = closeAlert;
window.closeAllAlerts = closeAllAlerts;

// Production warning removal
console.log = function() {
    // Filter out sensitive data from console logs
    const args = Array.prototype.slice.call(arguments);
    args.forEach(arg => {
        if (typeof arg === 'string' && (arg.includes('key_id') || arg.includes('apiKey'))) {
            return; // Don't log sensitive data
        }
        if (typeof arg === 'object' && arg) {
            // Remove sensitive keys from objects
            const cleanObj = JSON.parse(JSON.stringify(arg));
            if (cleanObj.key) delete cleanObj.key;
            if (cleanObj.apiKey) delete cleanObj.apiKey;
            if (cleanConfig?.firebase?.apiKey) delete cleanConfig.firebase.apiKey;
            console._log(cleanObj);
        } else {
            console._log(arg);
        }
    });
};

// Store original console.log
console._log = console.log;
</script>
</body>
</html>
